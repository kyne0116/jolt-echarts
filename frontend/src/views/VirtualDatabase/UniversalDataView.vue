<template>
  <div class="universal-data-view-container">
    <div class="page-header">
      <h2>ЁЯЧДя╕П UniversalChartDataView цХ░цНочобчРЖ</h2>
      <p class="page-description">чобчРЖцибцЛЯцХ░цНочЪДхнЧцо╡хоЪф╣ЙхТМцХ░цНошо░х╜Хя╝МцФпцМБхКицАБхнЧцо╡цЙйх▒Х</p>
    </div>

    <a-row :gutter="24">
      <!-- х╖жф╛зя╝ЪхКЯшГ╜хп╝шИк -->
      <a-col :span="6">
        <a-card title="цХ░цНочобчРЖ" class="navigation-card">
          <a-menu 
            v-model:selectedKeys="selectedMenuKeys" 
            mode="inline"
            @click="onMenuClick"
          >
            <a-menu-item key="field-management">
              <template #icon><SettingOutlined /></template>
              хнЧцо╡чобчРЖ
            </a-menu-item>
            <a-menu-item key="data-records">
              <template #icon><TableOutlined /></template>
              цХ░цНошо░х╜Х
            </a-menu-item>
            <a-menu-item key="data-import">
              <template #icon><ImportOutlined /></template>
              цХ░цНохп╝хЕе
            </a-menu-item>
            <a-menu-item key="data-export">
              <template #icon><ExportOutlined /></template>
              цХ░цНохп╝хЗ║
            </a-menu-item>
            <a-menu-item key="statistics">
              <template #icon><BarChartOutlined /></template>
              ч╗Яшобф┐бцБп
            </a-menu-item>
          </a-menu>
        </a-card>
      </a-col>

      <!-- хП│ф╛зя╝Ъф╕╗шжБхЖЕхо╣хМ║хЯЯ -->
      <a-col :span="18">
        <!-- хнЧцо╡чобчРЖчХМщЭв -->
        <a-card 
          v-if="currentView === 'field-management'" 
          title="хнЧцо╡чобчРЖ" 
          class="content-card"
        >
          <template #extra>
            <a-space>
              <a-button type="primary" @click="showAddFieldModal">
                <PlusOutlined />
                ц╖╗хКахнЧцо╡
              </a-button>
              <a-button @click="refreshFieldData">
                <ReloadOutlined />
                хИ╖цЦ░
              </a-button>
            </a-space>
          </template>

          <!-- хнЧцо╡чобчРЖшбица╝ -->
          <a-table
            :columns="fieldColumns"
            :data-source="fieldList"
            :loading="fieldLoading"
            :pagination="{ pageSize: 10, showSizeChanger: true, showQuickJumper: true }"
            row-key="fieldName"
          >
            <template #bodyCell="{ column, record }">
              <template v-if="column.key === 'fieldType'">
                <a-tag :color="getFieldTypeColor(record.dataType)">
                  {{ record.dataType?.displayName || record.dataType }}
                </a-tag>
              </template>
              <template v-else-if="column.key === 'required'">
                <a-tag :color="record.required ? 'red' : 'default'">
                  {{ record.required ? 'х┐Ехбл' : 'хПпщАЙ' }}
                </a-tag>
              </template>
              <template v-else-if="column.key === 'fieldGroup'">
                <a-tag color="blue">{{ record.fieldGroup || 'цЬкхИЖч╗Д' }}</a-tag>
              </template>
              <template v-else-if="column.key === 'action'">
                <a-space>
                  <a-button type="link" size="small" @click="editField(record)">
                    <EditOutlined />
                    ч╝Цш╛С
                  </a-button>
                  <a-button type="link" size="small" danger @click="deleteField(record)">
                    <DeleteOutlined />
                    хИащЩд
                  </a-button>
                </a-space>
              </template>
            </template>
          </a-table>
        </a-card>

        <!-- цХ░цНошо░х╜ХчобчРЖчХМщЭв -->
        <a-card 
          v-else-if="currentView === 'data-records'" 
          title="цХ░цНошо░х╜ХчобчРЖ" 
          class="content-card"
        >
          <template #extra>
            <a-space>
              <a-button type="primary" @click="showAddRecordModal">
                <PlusOutlined />
                ц╖╗хКашо░х╜Х
              </a-button>
              <a-button @click="showBatchEditModal">
                <EditOutlined />
                цЙ╣щЗПч╝Цш╛С
              </a-button>
              <a-button @click="refreshRecordData">
                <ReloadOutlined />
                хИ╖цЦ░
              </a-button>
            </a-space>
          </template>

          <!-- цХ░цНошо░х╜Хшбица╝ -->
          <a-table
            :columns="recordColumns"
            :data-source="recordList"
            :loading="recordLoading"
            :pagination="{ 
              pageSize: 20, 
              showSizeChanger: true, 
              showQuickJumper: true,
              showTotal: (total) => `хЕ▒ ${total} цЭбшо░х╜Х`
            }"
            :scroll="{ x: 'max-content' }"
            row-key="id"
          >
            <template #bodyCell="{ column, record }">
              <template v-if="column.key === 'action'">
                <a-space>
                  <a-button type="link" size="small" @click="editRecord(record)">
                    <EditOutlined />
                    ч╝Цш╛С
                  </a-button>
                  <a-button type="link" size="small" @click="duplicateRecord(record)">
                    <CopyOutlined />
                    хдНхИ╢
                  </a-button>
                  <a-button type="link" size="small" danger @click="deleteRecord(record)">
                    <DeleteOutlined />
                    хИащЩд
                  </a-button>
                </a-space>
              </template>
            </template>
          </a-table>
        </a-card>

        <!-- цХ░цНохп╝хЕечХМщЭв -->
        <a-card 
          v-else-if="currentView === 'data-import'" 
          title="цХ░цНохп╝хЕе" 
          class="content-card"
        >
          <a-upload-dragger
            v-model:fileList="importFileList"
            :before-upload="beforeUpload"
            @change="handleImportFileChange"
            accept=".json,.csv,.xlsx"
            :multiple="false"
          >
            <p class="ant-upload-drag-icon">
              <InboxOutlined />
            </p>
            <p class="ant-upload-text">чВ╣хЗ╗цИЦцЛЦцЛ╜цЦЗф╗╢хИ░цндхМ║хЯЯф╕Кф╝а</p>
            <p class="ant-upload-hint">
              цФпцМБ JSONуАБCSVуАБExcel ца╝х╝ПцЦЗф╗╢уАВхНХцмбф╕Кф╝аф╕Аф╕кцЦЗф╗╢уАВ
            </p>
          </a-upload-dragger>

          <a-divider />

          <div v-if="importPreviewData.length > 0">
            <h3>хп╝хЕещвДшзИ</h3>
            <a-table
              :columns="importPreviewColumns"
              :data-source="importPreviewData"
              :pagination="{ pageSize: 5 }"
              size="small"
            />
            
            <div style="margin-top: 16px; text-align: right;">
              <a-space>
                <a-button @click="clearImportPreview">ц╕Ечй║щвДшзИ</a-button>
                <a-button type="primary" @click="confirmImport" :loading="importLoading">
                  чбошодхп╝хЕе {{ importPreviewData.length }} цЭбшо░х╜Х
                </a-button>
              </a-space>
            </div>
          </div>
        </a-card>

        <!-- цХ░цНохп╝хЗ║чХМщЭв -->
        <a-card 
          v-else-if="currentView === 'data-export'" 
          title="цХ░цНохп╝хЗ║" 
          class="content-card"
        >
          <a-form layout="vertical">
            <a-row :gutter="16">
              <a-col :span="12">
                <a-form-item label="хп╝хЗ║ца╝х╝П">
                  <a-select v-model:value="exportFormat" placeholder="щАЙцЛйхп╝хЗ║ца╝х╝П">
                    <a-select-option value="json">JSON ца╝х╝П</a-select-option>
                    <a-select-option value="csv">CSV ца╝х╝П</a-select-option>
                    <a-select-option value="xlsx">Excel ца╝х╝П</a-select-option>
                  </a-select>
                </a-form-item>
              </a-col>
              <a-col :span="12">
                <a-form-item label="хп╝хЗ║шМГхЫ┤">
                  <a-select v-model:value="exportRange" placeholder="щАЙцЛйхп╝хЗ║шМГхЫ┤">
                    <a-select-option value="all">хЕищГицХ░цНо</a-select-option>
                    <a-select-option value="current">х╜УхЙНщб╡цХ░цНо</a-select-option>
                    <a-select-option value="selected">щАЙф╕нцХ░цНо</a-select-option>
                  </a-select>
                </a-form-item>
              </a-col>
            </a-row>
            
            <a-form-item label="хМЕхРлхнЧцо╡">
              <a-checkbox-group v-model:value="exportFields" :options="exportFieldOptions" />
            </a-form-item>
            
            <a-form-item>
              <a-space>
                <a-button type="primary" @click="exportData" :loading="exportLoading">
                  <DownloadOutlined />
                  хп╝хЗ║цХ░цНо
                </a-button>
                <a-button @click="resetExportForm">щЗНч╜о</a-button>
              </a-space>
            </a-form-item>
          </a-form>
        </a-card>

        <!-- ч╗Яшобф┐бцБпчХМщЭв -->
        <a-card 
          v-else-if="currentView === 'statistics'" 
          title="ч╗Яшобф┐бцБп" 
          class="content-card"
        >
          <a-row :gutter="16">
            <a-col :span="6">
              <a-statistic title="цА╗хнЧцо╡цХ░" :value="statisticsData.totalFields" />
            </a-col>
            <a-col :span="6">
              <a-statistic title="хЯ║чбАхнЧцо╡" :value="statisticsData.baseFields" />
            </a-col>
            <a-col :span="6">
              <a-statistic title="хКицАБхнЧцо╡" :value="statisticsData.dynamicFields" />
            </a-col>
            <a-col :span="6">
              <a-statistic title="цХ░цНошо░х╜Х" :value="statisticsData.totalRecords" />
            </a-col>
          </a-row>

          <a-divider />

          <a-row :gutter="16">
            <a-col :span="12">
              <a-card title="хнЧцо╡ч▒╗хЮЛхИЖх╕Г" size="small">
                <div ref="fieldTypeChart" style="height: 300px;"></div>
              </a-card>
            </a-col>
            <a-col :span="12">
              <a-card title="хнЧцо╡хИЖч╗ДхИЖх╕Г" size="small">
                <div ref="fieldGroupChart" style="height: 300px;"></div>
              </a-card>
            </a-col>
          </a-row>
        </a-card>
      </a-col>
    </a-row>

    <!-- ц╖╗хКахнЧцо╡цибцАБцбЖ -->
    <a-modal
      v-model:open="addFieldModalVisible"
      title="ц╖╗хКахнЧцо╡"
      @ok="handleAddField"
      @cancel="cancelAddField"
      :confirm-loading="addFieldLoading"
    >
      <a-form
        ref="addFieldFormRef"
        :model="addFieldForm"
        :rules="addFieldRules"
        layout="vertical"
      >
        <a-form-item label="хнЧцо╡хРНчз░" name="fieldName">
          <a-input v-model:value="addFieldForm.fieldName" placeholder="шп╖ш╛УхЕехнЧцо╡хРНчз░" />
        </a-form-item>
        <a-form-item label="цШ╛чд║хРНчз░" name="displayName">
          <a-input v-model:value="addFieldForm.displayName" placeholder="шп╖ш╛УхЕецШ╛чд║хРНчз░" />
        </a-form-item>
        <a-form-item label="цХ░цНоч▒╗хЮЛ" name="dataType">
          <a-select v-model:value="addFieldForm.dataType" placeholder="щАЙцЛйцХ░цНоч▒╗хЮЛ">
            <a-select-option value="STRING">хнЧчмжф╕▓</a-select-option>
            <a-select-option value="NUMBER">цХ░хнЧ</a-select-option>
            <a-select-option value="BOOLEAN">х╕Гх░ФхА╝</a-select-option>
            <a-select-option value="DATE">цЧецЬЯ</a-select-option>
            <a-select-option value="ARRAY">цХ░ч╗Д</a-select-option>
            <a-select-option value="OBJECT">хп╣ш▒б</a-select-option>
          </a-select>
        </a-form-item>
        <a-form-item label="хнЧцо╡хИЖч╗Д" name="fieldGroup">
          <a-input v-model:value="addFieldForm.fieldGroup" placeholder="шп╖ш╛УхЕехнЧцо╡хИЖч╗Д" />
        </a-form-item>
        <a-form-item label="цППш┐░" name="description">
          <a-textarea v-model:value="addFieldForm.description" placeholder="шп╖ш╛УхЕехнЧцо╡цППш┐░" />
        </a-form-item>
        <a-form-item name="required">
          <a-checkbox v-model:checked="addFieldForm.required">х┐ЕхблхнЧцо╡</a-checkbox>
        </a-form-item>
      </a-form>
    </a-modal>

    <!-- ц╖╗хКашо░х╜ХцибцАБцбЖ -->
    <a-modal
      v-model:open="addRecordModalVisible"
      title="ц╖╗хКацХ░цНошо░х╜Х"
      @ok="handleAddRecord"
      @cancel="cancelAddRecord"
      :confirm-loading="addRecordLoading"
      width="800px"
    >
      <a-form
        ref="addRecordFormRef"
        :model="addRecordForm"
        layout="vertical"
      >
        <a-row :gutter="16">
          <a-col :span="12" v-for="field in availableFields" :key="field.fieldName">
            <a-form-item :label="field.displayName" :name="field.fieldName">
              <a-input 
                v-if="field.dataType === 'STRING'"
                v-model:value="addRecordForm[field.fieldName]" 
                :placeholder="`шп╖ш╛УхЕе${field.displayName}`" 
              />
              <a-input-number 
                v-else-if="field.dataType === 'NUMBER'"
                v-model:value="addRecordForm[field.fieldName]" 
                :placeholder="`шп╖ш╛УхЕе${field.displayName}`"
                style="width: 100%"
              />
              <a-switch 
                v-else-if="field.dataType === 'BOOLEAN'"
                v-model:checked="addRecordForm[field.fieldName]"
              />
              <a-date-picker 
                v-else-if="field.dataType === 'DATE'"
                v-model:value="addRecordForm[field.fieldName]"
                style="width: 100%"
              />
              <a-textarea 
                v-else
                v-model:value="addRecordForm[field.fieldName]" 
                :placeholder="`шп╖ш╛УхЕе${field.displayName}`"
                :rows="2"
              />
            </a-form-item>
          </a-col>
        </a-row>
      </a-form>
    </a-modal>
  </div>
</template>

<script setup lang="ts">
import {
    BarChartOutlined,
    CopyOutlined,
    DeleteOutlined,
    DownloadOutlined,
    EditOutlined,
    ExportOutlined,
    ImportOutlined,
    InboxOutlined,
    PlusOutlined,
    ReloadOutlined,
    SettingOutlined,
    TableOutlined
} from '@ant-design/icons-vue'
import { message } from 'ant-design-vue'
import * as echarts from 'echarts'
import { nextTick, onMounted, reactive, ref } from 'vue'

// ==================== хУНх║Фх╝ПцХ░цНо ====================

// х╜УхЙНшзЖхЫ╛
const currentView = ref('field-management')
const selectedMenuKeys = ref(['field-management'])

// хнЧцо╡чобчРЖчЫ╕хЕ│
const fieldList = ref([])
const fieldLoading = ref(false)
const addFieldModalVisible = ref(false)
const addFieldLoading = ref(false)
const addFieldForm = reactive({
  fieldName: '',
  displayName: '',
  dataType: '',
  fieldGroup: '',
  description: '',
  required: false
})

// цХ░цНошо░х╜ХчобчРЖчЫ╕хЕ│
const recordList = ref([])
const recordLoading = ref(false)
const addRecordModalVisible = ref(false)
const addRecordLoading = ref(false)
const addRecordForm = reactive({})

// цХ░цНохп╝хЕечЫ╕хЕ│
const importFileList = ref([])
const importPreviewData = ref([])
const importPreviewColumns = ref([])
const importLoading = ref(false)

// цХ░цНохп╝хЗ║чЫ╕хЕ│
const exportFormat = ref('json')
const exportRange = ref('all')
const exportFields = ref([])
const exportFieldOptions = ref([])
const exportLoading = ref(false)

// ч╗Яшобф┐бцБпчЫ╕хЕ│
const statisticsData = reactive({
  totalFields: 0,
  baseFields: 0,
  dynamicFields: 0,
  totalRecords: 0
})

// хПпчФихнЧцо╡хИЧшби
const availableFields = ref([])

// ==================== шбица╝хИЧхоЪф╣Й ====================

// хнЧцо╡чобчРЖшбица╝хИЧ
const fieldColumns = [
  {
    title: 'хнЧцо╡хРНчз░',
    dataIndex: 'fieldName',
    key: 'fieldName',
    width: 150
  },
  {
    title: 'цШ╛чд║хРНчз░',
    dataIndex: 'displayName',
    key: 'displayName',
    width: 150
  },
  {
    title: 'цХ░цНоч▒╗хЮЛ',
    dataIndex: 'dataType',
    key: 'fieldType',
    width: 120
  },
  {
    title: 'цШпхРжх┐Ехбл',
    dataIndex: 'required',
    key: 'required',
    width: 100
  },
  {
    title: 'хнЧцо╡хИЖч╗Д',
    dataIndex: 'fieldGroup',
    key: 'fieldGroup',
    width: 120
  },
  {
    title: 'цППш┐░',
    dataIndex: 'description',
    key: 'description',
    ellipsis: true
  },
  {
    title: 'цУНф╜Ь',
    key: 'action',
    width: 150,
    fixed: 'right'
  }
]

// цХ░цНошо░х╜Хшбица╝хИЧя╝ИхКицАБчФЯцИРя╝Й
const recordColumns = ref([])

// шбихНХщкМшпБшзДхИЩ
const addFieldRules = {
  fieldName: [
    { required: true, message: 'шп╖ш╛УхЕехнЧцо╡хРНчз░' },
    { pattern: /^[a-zA-Z_][a-zA-Z0-9_]*$/, message: 'хнЧцо╡хРНчз░хПкшГ╜хМЕхРлхнЧцпНуАБцХ░хнЧхТМф╕ЛхИТч║┐я╝Мф╕Фф╕НшГ╜ф╗ецХ░хнЧх╝Ахд┤' }
  ],
  displayName: [
    { required: true, message: 'шп╖ш╛УхЕецШ╛чд║хРНчз░' }
  ],
  dataType: [
    { required: true, message: 'шп╖щАЙцЛйцХ░цНоч▒╗хЮЛ' }
  ]
}

// ==================== чФЯхС╜хСицЬЯ ====================

onMounted(() => {
  loadFieldData()
  loadRecordData()
  loadStatisticsData()
})

// ==================== цЦ╣ц│ХхоЪф╣Й ====================

// шПЬхНХчВ╣хЗ╗ф║Лф╗╢
const onMenuClick = ({ key }: { key: string }) => {
  currentView.value = key
  selectedMenuKeys.value = [key]

  // ца╣цНощАЙцЛйчЪДшПЬхНХхКаш╜╜хп╣х║ФцХ░цНо
  switch (key) {
    case 'field-management':
      loadFieldData()
      break
    case 'data-records':
      loadRecordData()
      break
    case 'statistics':
      loadStatisticsData()
      nextTick(() => {
        renderCharts()
      })
      break
  }
}

// хКаш╜╜хнЧцо╡цХ░цНо
const loadFieldData = async () => {
  fieldLoading.value = true
  try {
    // ш░ГчФиAPIшО╖хПЦхнЧцо╡хИЧшби
    const response = await fetch('/api/chart/dynamic-mapping/available-fields')
    const result = await response.json()

    if (result.success) {
      // хРИх╣╢хЯ║чбАхнЧцо╡хТМхКицАБхнЧцо╡
      const baseFields = Object.entries(result.data.baseFields).flatMap(([group, fields]) =>
        (fields as string[]).map(fieldName => ({
          fieldName,
          displayName: fieldName,
          dataType: 'STRING',
          fieldGroup: group,
          description: `хЯ║чбАхнЧцо╡: ${fieldName}`,
          required: false,
          isBaseField: true
        }))
      )

      const dynamicFields = Object.values(result.data.dynamicFields).map((field: any) => ({
        ...field,
        isBaseField: false
      }))

      fieldList.value = [...baseFields, ...dynamicFields]
      availableFields.value = fieldList.value

      console.log('тЬЕ [хнЧцо╡чобчРЖ] хКаш╜╜хнЧцо╡цХ░цНоцИРхКЯ:', fieldList.value.length)
    } else {
      message.error('хКаш╜╜хнЧцо╡цХ░цНохд▒ш┤е: ' + result.message)
    }
  } catch (error) {
    console.error('тЭМ [хнЧцо╡чобчРЖ] хКаш╜╜хнЧцо╡цХ░цНохд▒ш┤е:', error)
    message.error('хКаш╜╜хнЧцо╡цХ░цНохд▒ш┤е')
  } finally {
    fieldLoading.value = false
  }
}

// хКаш╜╜цХ░цНошо░х╜Х
const loadRecordData = async () => {
  recordLoading.value = true
  try {
    // ш░ГчФиAPIшО╖хПЦцХ░цНошо░х╜Х
    const response = await fetch('/api/chart/data/universal-view')
    const result = await response.json()

    if (result.success) {
      recordList.value = result.data || []

      // хКицАБчФЯцИРшбица╝хИЧ
      if (recordList.value.length > 0) {
        const firstRecord = recordList.value[0]
        recordColumns.value = Object.keys(firstRecord).map(key => ({
          title: key,
          dataIndex: key,
          key: key,
          width: 120,
          ellipsis: true
        }))

        // ц╖╗хКацУНф╜ЬхИЧ
        recordColumns.value.push({
          title: 'цУНф╜Ь',
          key: 'action',
          width: 180,
          fixed: 'right'
        })
      }

      console.log('тЬЕ [цХ░цНошо░х╜Х] хКаш╜╜цХ░цНошо░х╜ХцИРхКЯ:', recordList.value.length)
    } else {
      message.error('хКаш╜╜цХ░цНошо░х╜Ххд▒ш┤е: ' + result.message)
    }
  } catch (error) {
    console.error('тЭМ [цХ░цНошо░х╜Х] хКаш╜╜цХ░цНошо░х╜Ххд▒ш┤е:', error)
    message.error('хКаш╜╜цХ░цНошо░х╜Ххд▒ш┤е')
  } finally {
    recordLoading.value = false
  }
}

// хКаш╜╜ч╗Яшобф┐бцБп
const loadStatisticsData = async () => {
  try {
    const response = await fetch('/api/chart/dynamic-mapping/stats')
    const result = await response.json()

    if (result.success) {
      const fieldStats = result.data.fieldStats
      statisticsData.totalFields = fieldStats.totalDefinitions + fieldStats.baseFieldCount
      statisticsData.baseFields = fieldStats.baseFieldCount
      statisticsData.dynamicFields = fieldStats.totalDefinitions
      statisticsData.totalRecords = recordList.value.length

      console.log('тЬЕ [ч╗Яшобф┐бцБп] хКаш╜╜ч╗ЯшобцХ░цНоцИРхКЯ')
    }
  } catch (error) {
    console.error('тЭМ [ч╗Яшобф┐бцБп] хКаш╜╜ч╗ЯшобцХ░цНохд▒ш┤е:', error)
  }
}

// шО╖хПЦхнЧцо╡ч▒╗хЮЛщвЬшЙ▓
const getFieldTypeColor = (dataType: string) => {
  const colorMap: Record<string, string> = {
    'STRING': 'blue',
    'NUMBER': 'green',
    'BOOLEAN': 'orange',
    'DATE': 'purple',
    'ARRAY': 'cyan',
    'OBJECT': 'magenta'
  }
  return colorMap[dataType] || 'default'
}

// цШ╛чд║ц╖╗хКахнЧцо╡цибцАБцбЖ
const showAddFieldModal = () => {
  addFieldModalVisible.value = true
  // щЗНч╜ошбихНХ
  Object.assign(addFieldForm, {
    fieldName: '',
    displayName: '',
    dataType: '',
    fieldGroup: '',
    description: '',
    required: false
  })
}

// хдДчРЖц╖╗хКахнЧцо╡
const handleAddField = async () => {
  addFieldLoading.value = true
  try {
    // ш┐ЩщЗМх║Фшпеш░ГчФиAPIц╖╗хКахнЧцо╡
    console.log('ц╖╗хКахнЧцо╡:', addFieldForm)

    // цибцЛЯAPIш░ГчФи
    await new Promise(resolve => setTimeout(resolve, 1000))

    message.success('хнЧцо╡ц╖╗хКацИРхКЯ')
    addFieldModalVisible.value = false
    loadFieldData() // щЗНцЦ░хКаш╜╜цХ░цНо
  } catch (error) {
    console.error('ц╖╗хКахнЧцо╡хд▒ш┤е:', error)
    message.error('ц╖╗хКахнЧцо╡хд▒ш┤е')
  } finally {
    addFieldLoading.value = false
  }
}

// хПЦц╢Иц╖╗хКахнЧцо╡
const cancelAddField = () => {
  addFieldModalVisible.value = false
}

// ч╝Цш╛СхнЧцо╡
const editField = (record: any) => {
  console.log('ч╝Цш╛СхнЧцо╡:', record)
  message.info('ч╝Цш╛СхнЧцо╡хКЯшГ╜х╝АхПСф╕н')
}

// хИащЩдхнЧцо╡
const deleteField = (record: any) => {
  console.log('хИащЩдхнЧцо╡:', record)
  message.info('хИащЩдхнЧцо╡хКЯшГ╜х╝АхПСф╕н')
}

// хИ╖цЦ░хнЧцо╡цХ░цНо
const refreshFieldData = () => {
  loadFieldData()
}

// цШ╛чд║ц╖╗хКашо░х╜ХцибцАБцбЖ
const showAddRecordModal = () => {
  addRecordModalVisible.value = true
  // щЗНч╜ошбихНХ
  Object.keys(addRecordForm).forEach(key => {
    delete addRecordForm[key]
  })
}

// хдДчРЖц╖╗хКашо░х╜Х
const handleAddRecord = async () => {
  addRecordLoading.value = true
  try {
    console.log('ц╖╗хКашо░х╜Х:', addRecordForm)

    // цибцЛЯAPIш░ГчФи
    await new Promise(resolve => setTimeout(resolve, 1000))

    message.success('цХ░цНошо░х╜Хц╖╗хКацИРхКЯ')
    addRecordModalVisible.value = false
    loadRecordData() // щЗНцЦ░хКаш╜╜цХ░цНо
  } catch (error) {
    console.error('ц╖╗хКашо░х╜Ххд▒ш┤е:', error)
    message.error('ц╖╗хКашо░х╜Ххд▒ш┤е')
  } finally {
    addRecordLoading.value = false
  }
}

// хПЦц╢Иц╖╗хКашо░х╜Х
const cancelAddRecord = () => {
  addRecordModalVisible.value = false
}

// ч╝Цш╛Сшо░х╜Х
const editRecord = (record: any) => {
  console.log('ч╝Цш╛Сшо░х╜Х:', record)
  message.info('ч╝Цш╛Сшо░х╜ХхКЯшГ╜х╝АхПСф╕н')
}

// хдНхИ╢шо░х╜Х
const duplicateRecord = (record: any) => {
  console.log('хдНхИ╢шо░х╜Х:', record)
  message.info('хдНхИ╢шо░х╜ХхКЯшГ╜х╝АхПСф╕н')
}

// хИащЩдшо░х╜Х
const deleteRecord = (record: any) => {
  console.log('хИащЩдшо░х╜Х:', record)
  message.info('хИащЩдшо░х╜ХхКЯшГ╜х╝АхПСф╕н')
}

// цШ╛чд║цЙ╣щЗПч╝Цш╛СцибцАБцбЖ
const showBatchEditModal = () => {
  message.info('цЙ╣щЗПч╝Цш╛СхКЯшГ╜х╝АхПСф╕н')
}

// хИ╖цЦ░шо░х╜ХцХ░цНо
const refreshRecordData = () => {
  loadRecordData()
}

// цЦЗф╗╢ф╕Кф╝ахЙНхдДчРЖ
const beforeUpload = (file: File) => {
  const isValidType = ['application/json', 'text/csv', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'].includes(file.type)
  if (!isValidType) {
    message.error('хПкцФпцМБ JSONуАБCSVуАБExcel ца╝х╝ПцЦЗф╗╢')
  }
  const isLt10M = file.size / 1024 / 1024 < 10
  if (!isLt10M) {
    message.error('цЦЗф╗╢хдзх░Пф╕НшГ╜ш╢Еш┐З 10MB')
  }
  return isValidType && isLt10M
}

// хдДчРЖхп╝хЕецЦЗф╗╢хПШхМЦ
const handleImportFileChange = (info: any) => {
  console.log('цЦЗф╗╢хПШхМЦ:', info)
  message.info('цЦЗф╗╢хп╝хЕехКЯшГ╜х╝АхПСф╕н')
}

// ц╕Ечй║хп╝хЕещвДшзИ
const clearImportPreview = () => {
  importPreviewData.value = []
  importPreviewColumns.value = []
  importFileList.value = []
}

// чбошодхп╝хЕе
const confirmImport = async () => {
  importLoading.value = true
  try {
    // цибцЛЯхп╝хЕеш┐ЗчиЛ
    await new Promise(resolve => setTimeout(resolve, 2000))

    message.success(`цИРхКЯхп╝хЕе ${importPreviewData.value.length} цЭбшо░х╜Х`)
    clearImportPreview()
    loadRecordData() // щЗНцЦ░хКаш╜╜цХ░цНо
  } catch (error) {
    console.error('хп╝хЕехд▒ш┤е:', error)
    message.error('хп╝хЕехд▒ш┤е')
  } finally {
    importLoading.value = false
  }
}

// хп╝хЗ║цХ░цНо
const exportData = async () => {
  exportLoading.value = true
  try {
    console.log('хп╝хЗ║щЕНч╜о:', {
      format: exportFormat.value,
      range: exportRange.value,
      fields: exportFields.value
    })

    // цибцЛЯхп╝хЗ║ш┐ЗчиЛ
    await new Promise(resolve => setTimeout(resolve, 1000))

    message.success('цХ░цНохп╝хЗ║цИРхКЯ')
  } catch (error) {
    console.error('хп╝хЗ║хд▒ш┤е:', error)
    message.error('хп╝хЗ║хд▒ш┤е')
  } finally {
    exportLoading.value = false
  }
}

// щЗНч╜охп╝хЗ║шбихНХ
const resetExportForm = () => {
  exportFormat.value = 'json'
  exportRange.value = 'all'
  exportFields.value = []
}

// ц╕▓цЯУч╗ЯшобхЫ╛шби
const renderCharts = () => {
  // хнЧцо╡ч▒╗хЮЛхИЖх╕ГхЫ╛шби
  const fieldTypeChart = echarts.init(document.querySelector('.field-type-chart'))
  const fieldTypeOption = {
    tooltip: {
      trigger: 'item'
    },
    series: [{
      type: 'pie',
      radius: '50%',
      data: [
        { value: 20, name: 'хнЧчмжф╕▓' },
        { value: 8, name: 'цХ░хнЧ' },
        { value: 4, name: 'цХ░ч╗Д' },
        { value: 3, name: 'х╕Гх░ФхА╝' },
        { value: 2, name: 'цЧецЬЯ' },
        { value: 3, name: 'хп╣ш▒б' }
      ]
    }]
  }
  fieldTypeChart.setOption(fieldTypeOption)

  // хнЧцо╡хИЖч╗ДхИЖх╕ГхЫ╛шби
  const fieldGroupChart = echarts.init(document.querySelector('.field-group-chart'))
  const fieldGroupOption = {
    tooltip: {
      trigger: 'axis'
    },
    xAxis: {
      type: 'category',
      data: ['хЯ║чбАф┐бцБп', 'цЧ╢щЧ┤ч╗┤х║ж', 'хИЖч▒╗цХ░цНо', 'цХ░хА╝хнЧцо╡', 'щЕНч╜охнЧцо╡', 'ф╕ЪхКбцЙйх▒Х']
    },
    yAxis: {
      type: 'value'
    },
    series: [{
      type: 'bar',
      data: [8, 8, 8, 8, 8, 4]
    }]
  }
  fieldGroupChart.setOption(fieldGroupOption)
}
</script>

<style scoped>
.universal-data-view-container {
  padding: 24px;
  background-color: #f5f5f5;
  min-height: 100vh;
}

.page-header {
  margin-bottom: 24px;
  text-align: center;
}

.page-header h2 {
  margin: 0;
  color: #1890ff;
  font-size: 28px;
  font-weight: 600;
}

.page-description {
  margin: 8px 0 0 0;
  color: #666;
  font-size: 16px;
}

.navigation-card {
  height: fit-content;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.navigation-card .ant-menu {
  border: none;
}

.navigation-card .ant-menu-item {
  margin: 4px 0;
  border-radius: 6px;
}

.content-card {
  min-height: 600px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.content-card .ant-card-head {
  border-bottom: 2px solid #f0f0f0;
}

.content-card .ant-card-head-title {
  font-size: 18px;
  font-weight: 600;
  color: #1890ff;
}

.ant-table {
  background: white;
  border-radius: 8px;
}

.ant-table-thead > tr > th {
  background-color: #fafafa;
  font-weight: 600;
  color: #262626;
}

.ant-statistic {
  text-align: center;
  padding: 16px;
  background: white;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.ant-statistic-title {
  color: #666;
  font-size: 14px;
}

.ant-statistic-content {
  color: #1890ff;
  font-weight: 600;
}

.ant-upload-dragger {
  border: 2px dashed #d9d9d9;
  border-radius: 8px;
  background: #fafafa;
  transition: all 0.3s;
}

.ant-upload-dragger:hover {
  border-color: #1890ff;
  background: #f0f8ff;
}

.ant-upload-drag-icon {
  font-size: 48px;
  color: #1890ff;
}

.ant-upload-text {
  font-size: 16px;
  color: #666;
  margin: 16px 0 8px 0;
}

.ant-upload-hint {
  color: #999;
  font-size: 14px;
}

.ant-form-item-label > label {
  font-weight: 600;
  color: #262626;
}

.ant-modal-header {
  border-bottom: 2px solid #f0f0f0;
}

.ant-modal-title {
  font-size: 18px;
  font-weight: 600;
  color: #1890ff;
}

.ant-tag {
  border-radius: 4px;
  font-weight: 500;
}

.ant-btn {
  border-radius: 6px;
  font-weight: 500;
}

.ant-btn-primary {
  background: linear-gradient(135deg, #1890ff 0%, #096dd9 100%);
  border: none;
  box-shadow: 0 2px 4px rgba(24, 144, 255, 0.3);
}

.ant-btn-primary:hover {
  background: linear-gradient(135deg, #40a9ff 0%, #1890ff 100%);
  box-shadow: 0 4px 8px rgba(24, 144, 255, 0.4);
}

.ant-divider {
  border-color: #e8e8e8;
  margin: 24px 0;
}

/* хУНх║Фх╝Пшо╛шоб */
@media (max-width: 1200px) {
  .universal-data-view-container {
    padding: 16px;
  }

  .page-header h2 {
    font-size: 24px;
  }

  .page-description {
    font-size: 14px;
  }
}

@media (max-width: 768px) {
  .universal-data-view-container {
    padding: 12px;
  }

  .ant-col:first-child {
    margin-bottom: 16px;
  }

  .content-card {
    min-height: auto;
  }
}

/* хЫ╛шбихо╣хЩица╖х╝П */
.field-type-chart,
.field-group-chart {
  width: 100%;
  height: 300px;
}

/* хКаш╜╜чК╢цАБца╖х╝П */
.ant-spin-container {
  min-height: 200px;
}

/* чй║чК╢цАБца╖х╝П */
.ant-empty {
  padding: 40px 0;
}

.ant-empty-description {
  color: #999;
  font-size: 14px;
}
</style>
