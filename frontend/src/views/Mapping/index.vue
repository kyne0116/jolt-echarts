<template>
  <div class="mapping-page">
    <!-- ÂõæË°®ÈÄâÊã©Âå∫Âüü -->
    <div class="chart-selection-section">
      <a-card class="selection-card" size="small">
        <template #title>
          <span class="section-title">üìä ÂõæË°®ÈÄâÊã©</span>
        </template>
        <ChartSelector
          ref="chartSelectorRef"
          @chart-selected="onChartSelected"
          class="chart-selector"
        />
      </a-card>
    </div>

    <!-- Êò†Â∞ÑÈÖçÁΩÆÂàóË°®Âå∫Âüü -->
    <div class="mapping-list-section">
      <a-card class="list-card" size="small">
        <template #title>
          <span class="section-title">üîó Êò†Â∞ÑÈÖçÁΩÆÂàóË°®</span>
        </template>
        <template #extra>
          <a-space>
            <a-button
              type="primary"
              size="small"
              @click="refreshList"
              :loading="loading"
            >
              <ReloadOutlined />
              Âà∑Êñ∞
            </a-button>
          </a-space>
        </template>

        <a-table
          :dataSource="mappingList"
          :columns="tableColumns"
          :pagination="paginationConfig"
          :loading="loading"
          size="small"
          row-key="instanceId"
          :scroll="{ x: 1200 }"
          class="compact-table"
        >
          <template #bodyCell="{ column, record }">
            <template v-if="column.key === 'actions'">
              <a-space size="small">
                <a-button type="link" size="small" @click="viewMapping(record)">
                  Êü•Áúã
                </a-button>
                <a-button type="link" size="small" @click="configureMapping(record)">
                  ÈÖçÁΩÆÊò†Â∞Ñ
                </a-button>
                <a-button
                  type="link"
                  size="small"
                  @click="previewChart(record)"
                  :loading="buttonLoading[record.chartId]"
                >
                  <EyeOutlined />
                  È¢ÑËßàÂõæË°®
                </a-button>
                <a-button type="link" size="small" @click="showConfigGuide(record)">
                  ÈÖçÁΩÆÊåáÂçó
                </a-button>
                <a-button type="link" size="small" danger @click="deleteMapping(record)">
                  Âà†Èô§
                </a-button>
              </a-space>
            </template>
          </template>
        </a-table>
      </a-card>
    </div>

    <!-- ÈÖçÁΩÆÊò†Â∞ÑÁã¨Á´ãÊµÆÂä®Á™óÂè£ -->
    <div
      v-if="mappingModalVisible"
      class="mapping-floating-window"
      :style="mappingWindowStyle"
      @click="bringToFront('mapping')"
    >
      <!-- Á™óÂè£Ê†áÈ¢òÊ†è -->
      <div
        class="window-header"
        @mousedown="startDrag($event, 'mapping')"
      >
        <div class="window-title">
          <span class="title-icon">üîß</span>
          <span class="title-text">{{ mappingModalTitle }}</span>
        </div>
        <div class="window-controls">
          <button
            class="control-btn close-btn"
            @click="mappingModalVisible = false"
            title="ÂÖ≥Èó≠"
          >
            ‚úï
          </button>
        </div>
      </div>

      <!-- Á™óÂè£ÂÜÖÂÆπ -->
      <div class="window-content">
        <div class="modal-content">
          <div v-if="selectedRecord">
          <!-- ÂõæË°®‰ø°ÊÅØÂ±ïÁ§∫ -->
          <a-descriptions title="ÂõæË°®‰ø°ÊÅØ" :column="2" size="small" bordered>
            <a-descriptions-item label="ÂõæË°®ID">{{ selectedRecord.chartId }}</a-descriptions-item>
            <a-descriptions-item label="ÂõæË°®Á±ªÂûã">{{ selectedRecord.chartType }}</a-descriptions-item>
            <a-descriptions-item label="ÂõæË°®ÂêçÁß∞">{{ selectedRecord.chartName }}</a-descriptions-item>
            <a-descriptions-item label="ÈÄöÁî®Ê®°Êùø">{{ selectedRecord.universalTemplate }}</a-descriptions-item>
          </a-descriptions>

          <!-- JOLTËßÑËåÉÊñá‰ª∂ÂÜÖÂÆπÂ±ïÁ§∫ -->
          <div class="jolt-spec-section" style="margin-top: 16px;">
            <h4>JOLTËßÑËåÉÊñá‰ª∂ÂÜÖÂÆπ</h4>
            <div v-if="joltSpecLoading" class="loading-container">
              <a-spin tip="Âä†ËΩΩJOLTËßÑËåÉÊñá‰ª∂‰∏≠..." />
            </div>
            <div v-else-if="joltSpecContent" class="jolt-spec-content">
              <div class="code-container">
                <pre class="code-block json-highlight"><code>{{ JSON.stringify(joltSpecContent, null, 2) }}</code></pre>
              </div>
            </div>
            <div v-else class="no-jolt-spec">
              <a-empty description="Êú™ÊâæÂà∞ÂØπÂ∫îÁöÑJOLTËßÑËåÉÊñá‰ª∂" />
            </div>
          </div>

          <!-- Âç†‰ΩçÁ¨¶Êò†Â∞ÑÈÖçÁΩÆ -->
          <div class="mapping-config-section">
            <h4>Âç†‰ΩçÁ¨¶Êò†Â∞ÑÈÖçÁΩÆ</h4>
            <div v-if="placeholdersLoading" class="loading-container">
              <a-spin tip="Âä†ËΩΩÂç†‰ΩçÁ¨¶‰∏≠..." />
            </div>
            <div v-else>
              <div class="mapping-header">
                <a-row :gutter="12">
                  <a-col :span="6"><strong>Âç†‰ΩçÁ¨¶</strong></a-col>
                  <a-col :span="6"><strong>Êò†Â∞ÑÂ≠óÊÆµ</strong></a-col>
                  <a-col :span="5"><strong>Êï∞ÊçÆÁ±ªÂûã</strong></a-col>
                  <a-col :span="5"><strong>ËÅöÂêàÊñπÂºè</strong></a-col>
                  <a-col :span="2"><strong>Êìç‰Ωú</strong></a-col>
                </a-row>
              </div>

              <div class="mapping-list">
                <div
                  v-for="placeholder in placeholders"
                  :key="placeholder"
                  class="mapping-item"
                >
                  <a-row :gutter="12" align="middle">
                    <a-col :span="6">
                      <div class="placeholder-info">
                        <a-tag :color="isMapped(placeholder) ? 'green' : 'orange'">
                          {{ placeholder }}
                        </a-tag>
                      </div>
                    </a-col>
                    <a-col :span="6">
                      <a-select
                        :value="getMappingFieldName(placeholder)"
                        @update:value="updateMappingFieldName(placeholder, $event)"
                        placeholder="ÈÄâÊã©Â≠óÊÆµ"
                        size="small"
                        style="width: 100%"
                        show-search
                        :filter-option="(input, option) =>
                          option.children.toLowerCase().indexOf(input.toLowerCase()) >= 0"
                        @change="onMappingChange(placeholder)"
                      >
                        <a-select-opt-group
                          v-for="group in groupedFields"
                          :key="group.name"
                          :label="group.name"
                        >
                          <a-select-option
                            v-for="field in group.fields"
                            :key="field.name"
                            :value="field.name"
                          >
                            {{ field.label }} ({{ field.name }})
                          </a-select-option>
                        </a-select-opt-group>
                      </a-select>
                    </a-col>
                    <a-col :span="5">
                      <a-select
                        :value="getMappingDataType(placeholder)"
                        @update:value="updateMappingDataType(placeholder, $event)"
                        placeholder="Êï∞ÊçÆÁ±ªÂûã"
                        size="small"
                        style="width: 100%"
                      >
                        <a-select-option value="string">Â≠óÁ¨¶‰∏≤</a-select-option>
                        <a-select-option value="number">Êï∞Â≠ó</a-select-option>
                        <a-select-option value="array">Êï∞ÁªÑ</a-select-option>
                        <a-select-option value="object">ÂØπË±°</a-select-option>
                      </a-select>
                    </a-col>
                    <a-col :span="5">
                      <a-select
                        :value="getMappingAggregationType(placeholder)"
                        @update:value="updateMappingAggregationType(placeholder, $event)"
                        placeholder="ËÅöÂêàÊñπÂºè"
                        size="small"
                        style="width: 100%"
                      >
                        <a-select-option value="none">Êó†</a-select-option>
                        <a-select-option value="sum">Ê±ÇÂíå</a-select-option>
                        <a-select-option value="avg">Âπ≥ÂùáÂÄº</a-select-option>
                        <a-select-option value="count">ËÆ°Êï∞</a-select-option>
                        <a-select-option value="max">ÊúÄÂ§ßÂÄº</a-select-option>
                        <a-select-option value="min">ÊúÄÂ∞èÂÄº</a-select-option>
                        <a-select-option value="list">ÂàóË°®</a-select-option>
                      </a-select>
                    </a-col>
                    <a-col :span="2">
                      <a-button
                        type="link"
                        size="small"
                        danger
                        @click="clearMapping(placeholder)"
                      >
                        Ê∏ÖÈô§
                      </a-button>
                    </a-col>
                  </a-row>
                </div>
              </div>
            </div>
          </div>

          <!-- Êò†Â∞ÑËøõÂ∫¶ -->
          <div class="mapping-progress">
            <a-progress
              :percent="mappingProgress"
              :status="mappingProgress === 100 ? 'success' : 'active'"
              :format="(percent) => `${percent}% (${mappedCount}/${placeholders.length})`"
            />
          </div>

          <!-- Á™óÂè£Â∫ïÈÉ®Êìç‰ΩúÊ†è -->
          <div class="window-footer">
            <div class="footer-actions">
              <button
                class="action-btn cancel-btn"
                @click="mappingModalVisible = false"
              >
                ÂèñÊ∂à
              </button>
              <button
                class="action-btn primary-btn"
                @click="saveMappingConfig"
                :disabled="savingConfig || mappingProgress === 0"
              >
                <span v-if="savingConfig" class="loading-icon">‚è≥</span>
                <span v-else>üíæ</span>
                {{ savingConfig ? '‰øùÂ≠ò‰∏≠...' : '‰øùÂ≠òÈÖçÁΩÆ' }}
              </button>
            </div>
          </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ÈÖçÁΩÆÊåáÂçóÁã¨Á´ãÊµÆÂä®Á™óÂè£ -->
    <div
      v-if="guideModalVisible"
      class="guide-floating-window"
      :style="guideWindowStyle"
      @click="bringToFront('guide')"
    >
      <!-- Á™óÂè£Ê†áÈ¢òÊ†è -->
      <div
        class="window-header"
        @mousedown="startDrag($event, 'guide')"
      >
        <div class="window-title">
          <span class="title-icon">üìñ</span>
          <span class="title-text">ÈÖçÁΩÆÊåáÂçó - {{ selectedRecord?.chartName || 'Êú™Áü•ÂõæË°®' }}</span>
        </div>
        <div class="window-controls">
          <button
            class="control-btn close-btn"
            @click="guideModalVisible = false"
            title="ÂÖ≥Èó≠"
          >
            ‚úï
          </button>
        </div>
      </div>

      <!-- Á™óÂè£ÂÜÖÂÆπ -->
      <div class="window-content">
        <div v-if="selectedRecord" class="guide-content">
          <div class="guide-panels">
            <!-- Èù¢Êùø1 - ÂÆòÊñπÂÆåÊï¥ÂÆû‰æã -->
            <div class="guide-panel">
              <div class="panel-header">
                <h4 class="panel-title">
                  <span class="panel-icon">üìä</span>
                  ËΩ¨Êç¢ÁªìÊûÑÂèäÂèòÈáè
                </h4>
                <a-tag color="blue" size="small">{{ selectedRecord.chartType }}</a-tag>
              </div>
              <div class="panel-content">
                <div class="section">
                  <h5>ÂõæË°®ÈÖçÁΩÆÊ®°Êùø</h5>
                  <div v-if="universalTemplateLoading" class="loading-container">
                    <a-spin tip="Ê≠£Âú®Âä†ËΩΩÈÄöÁî®Ê®°Êùø..." />
                  </div>
                  <div v-else-if="universalTemplateError" class="error-container">
                    <a-alert
                      :message="universalTemplateError"
                      type="error"
                      show-icon
                      style="margin-bottom: 16px;"
                    />
                    <a-button
                      type="primary"
                      size="small"
                      @click="loadUniversalTemplate(selectedRecord?.chartId || '')"
                    >
                      ÈáçÊñ∞Âä†ËΩΩ
                    </a-button>
                  </div>
                  <div v-else-if="universalTemplateContent" class="code-container">
                    <div class="code-header">
                      <span class="code-title">{{ universalTemplateTitle }}</span>
                      <a-button
                        type="text"
                        size="small"
                        @click="copyToClipboard(JSON.stringify(universalTemplateContent, null, 2))"
                      >
                        Â§çÂà∂
                      </a-button>
                    </div>
                    <pre class="code-block universal-template-code"><code>{{ JSON.stringify(universalTemplateContent, null, 2) }}</code></pre>
                  </div>
                  <div v-else class="empty-container">
                    <a-empty description="ÊöÇÊó†Ê®°ÊùøÊï∞ÊçÆ" />
                  </div>
                </div>
                <div class="section">
                  <h5>ÁªìÊûÑËØ¥Êòé</h5>
                  <ul class="description-list">
                    <li v-for="desc in getStructureDescription()" :key="desc">
                      {{ desc }}
                    </li>
                  </ul>
                </div>
                <div class="section">
                  <h5>ÂèòÈáèËØ¥Êòé</h5>
                  <ul class="description-list">
                    <li v-for="variable in getVariableDescription()" :key="variable">
                      {{ variable }}
                    </li>
                  </ul>
                </div>
              </div>
            </div>

            <!-- Èù¢Êùø2 - ËΩ¨Êç¢ÁªìÊûÑËØ¥Êòé -->
            <div class="guide-panel">
              <div class="panel-header">
                <h4 class="panel-title">
                  <span class="panel-icon">üîÑ</span>
                  ËΩ¨Êç¢Êï∞ÊçÆÂèäÁ§∫‰æã
                </h4>
                <a-tag color="orange" size="small">{{ selectedRecord.universalTemplate }}</a-tag>
              </div>
              <div class="panel-content">
                <div class="section">
                  <h5>{{ databaseViewTitle }}</h5>
                  <div class="code-container">
                    <pre class="code-block"><code>{{ getDatabaseViewData() }}</code></pre>
                  </div>

                  <h6 style="display: flex; align-items: center; justify-content: space-between;">
                    <span>{{ echartsDataTitle }}</span>
                    <a-button
                      type="primary"
                      size="small"
                      @click="showChartPreview"
                      :loading="modalLoading"
                    >
                      È¢ÑËßà
                    </a-button>
                  </h6>
                  <div class="code-container">
                    <pre class="code-block"><code>{{ getTransformationAfter() }}</code></pre>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ÂõæË°®È¢ÑËßàÂºπÊ°Ü -->
    <a-modal
      v-model:open="chartPreviewVisible"
      title="ÂõæË°®È¢ÑËßà"
      width="800px"
      :footer="null"
      :mask-closable="true"
      :keyboard="true"
      :z-index="2000"
      @cancel="handlePreviewClose"
      centered
    >
      <div class="chart-preview-content">
        <div v-if="modalLoading" class="preview-loading">
          <a-spin tip="Ê≠£Âú®ÁîüÊàêÂõæË°®È¢ÑËßà..." size="large" />
        </div>
        <div v-show="!modalLoading" class="preview-container">
          <div ref="chartPreviewRef" class="chart-preview-canvas" style="height: 500px; width: 100%;"></div>
          <div v-if="!chartPreviewData" class="no-preview">
            <a-empty description="ÊöÇÊó†È¢ÑËßàÊï∞ÊçÆ" />
          </div>
        </div>
      </div>
    </a-modal>

    <!-- ÂõæË°®È¢ÑËßàÂºπÁ™ó -->
    <a-modal
      v-model:open="chartPreviewVisible"
      title="ÂõæË°®È¢ÑËßà"
      width="80%"
      :footer="null"
      :destroyOnClose="true"
    >
      <div class="chart-preview-container">
        <div v-if="previewError" class="preview-error">
          <a-alert
            :message="previewError"
            type="error"
            show-icon
            :closable="false"
          />
        </div>
        <div v-else-if="previewChartConfig" class="chart-container">
          <div ref="chartPreviewRef" style="width: 100%; height: 500px;"></div>
        </div>
        <div v-else class="preview-loading">
          <a-spin size="large" tip="Ê≠£Âú®ÁîüÊàêÂõæË°®È¢ÑËßà...">
            <div style="height: 400px;"></div>
          </a-spin>
        </div>
      </div>
    </a-modal>
  </div>
</template>

<script setup lang="ts">
import { placeholderMappingApi, twoStageApi, universalTemplateApi } from '@/api'
import ChartSelector from '@/components/ChartSelector.vue'
import { EyeOutlined, ReloadOutlined } from '@ant-design/icons-vue'
import { message } from 'ant-design-vue'
import * as echarts from 'echarts'
import { computed, nextTick, onMounted, reactive, ref, watch } from 'vue'

// Êé•Âè£Á±ªÂûãÂÆö‰πâ
interface MappingRecord {
  instanceId: number
  chartId: string
  instanceName: string
  chartType: string
  chartName: string
  universalTemplate: string
  joltSpecFile: string
  placeholderCount: number
}

interface SelectedChart {
  chartId: string
  templateType: string
  chartFile: string
  chartName: string
  joltSpecFile: string
}

// ÂìçÂ∫îÂºèÊï∞ÊçÆ
const chartSelectorRef = ref()
const loading = ref(false)
const mappingList = ref<MappingRecord[]>([])
const selectedRecord = ref<MappingRecord | null>(null)

// ÂõæË°®È¢ÑËßàÁõ∏ÂÖ≥
const chartPreviewVisible = ref(false)
const buttonLoading = ref<Record<string, boolean>>({})  // ÊåâÈíÆÂä†ËΩΩÁä∂ÊÄÅ
const modalLoading = ref(false)  // ÂºπÁ™óÂä†ËΩΩÁä∂ÊÄÅ
const previewChartConfig = ref<any>(null)
const previewError = ref<string>('')
const chartPreviewRef = ref<HTMLElement>()

// ÈÄâ‰∏≠ÁöÑÂõæË°®‰ø°ÊÅØ
const selectedChart = reactive<SelectedChart>({
  chartId: '',
  templateType: '',
  chartFile: '',
  chartName: '',
  joltSpecFile: ''
})

// Ê®°ÊÄÅÊ°ÜÁä∂ÊÄÅ
const mappingModalVisible = ref(false)
const guideModalVisible = ref(false)

// ÊãñÊãΩÁä∂ÊÄÅ
const isDragging = ref(false)
const dragTarget = ref('')
const mappingModalPosition = ref({ top: 100, left: 150 })
const guideModalPosition = ref({ top: 150, left: 300 })

// Êò†Â∞ÑÈÖçÁΩÆÁõ∏ÂÖ≥Áä∂ÊÄÅ
const placeholders = ref<string[]>([])
const placeholdersLoading = ref(false)
const mappingConfigs = reactive<Record<string, any>>({})
const savingConfig = ref(false)
const availableFields = ref<any[]>([])

// JOLTËßÑËåÉÊñá‰ª∂Áõ∏ÂÖ≥Áä∂ÊÄÅ
const joltSpecContent = ref<any>(null)
const joltSpecLoading = ref(false)

// ÈÄöÁî®Ê®°ÊùøÁõ∏ÂÖ≥Áä∂ÊÄÅ
const universalTemplateContent = ref<any>(null)
const universalTemplateFileName = ref<string>('')
const universalTemplateLoading = ref(false)
const universalTemplateError = ref<string | null>(null)

// ÂõæË°®È¢ÑËßàÊï∞ÊçÆ
const chartPreviewData = ref<any>(null)

// ËÆ°ÁÆóÂ±ûÊÄß
const mappedCount = computed(() => {
  return placeholders.value.filter(p => isMapped(p)).length
})

const mappingProgress = computed(() => {
  if (placeholders.value.length === 0) return 0
  return Math.round((mappedCount.value / placeholders.value.length) * 100)
})

// Ë°®Ê†ºÂàóÂÆö‰πâ - ÊåâË¶ÅÊ±ÇÈáçÊñ∞ÊéíÂàóÂàóÈ°∫Â∫èÔºåÁ¥ßÂáëÂûãÊ†∑Âºè
const tableColumns = [
  { title: 'ÂÆû‰æãID', dataIndex: 'instanceId', key: 'instanceId', width: 70, align: 'center' },
  { title: 'ÂÆû‰æãÂêçÁß∞', dataIndex: 'instanceName', key: 'instanceName', width: 180, ellipsis: true },
  { title: 'ÈÄöÁî®JSONÊ®°Êùø', dataIndex: 'universalTemplate', key: 'universalTemplate', width: 160, ellipsis: true },
  { title: 'ÂõæË°®Á±ªÂûã', dataIndex: 'chartType', key: 'chartType', width: 80, align: 'center' },
  { title: 'ÂõæË°®ÂêçÁß∞', dataIndex: 'chartName', key: 'chartName', width: 130, ellipsis: true },
  { title: 'ÂõæË°®ID', dataIndex: 'chartId', key: 'chartId', width: 140, ellipsis: true },
  { title: 'JOLTËΩ¨Êç¢ËßÑËåÉ', dataIndex: 'joltSpecFile', key: 'joltSpecFile', width: 140, ellipsis: true },
  { title: 'Âç†‰ΩçÁ¨¶Êï∞Èáè', dataIndex: 'placeholderCount', key: 'placeholderCount', width: 90, align: 'center' },
  { title: 'Êìç‰Ωú', key: 'actions', width: 260, fixed: 'right' }
]

// ÂàÜÈ°µÈÖçÁΩÆ - ‰∏éÊï∞ÊçÆÁÆ°ÁêÜÈ°µÈù¢‰øùÊåÅ‰∏ÄËá¥
const paginationConfig = reactive({
  current: 1,
  pageSize: 10,
  total: 0,
  showSizeChanger: true,
  showQuickJumper: true,
  showTotal: (total: number, range: [number, number]) =>
    `Á¨¨ ${range[0]}-${range[1]} Êù°/ÂÖ± ${total} Êù°`,
  onChange: (page: number, size: number) => {
    paginationConfig.current = page
    paginationConfig.pageSize = size
  },
  onShowSizeChange: (current: number, size: number) => {
    paginationConfig.current = 1
    paginationConfig.pageSize = size
  }
})

// ËÆ°ÁÆóÂ±ûÊÄß
const mappingModalTitle = computed(() =>
  selectedRecord.value ? `ÈÖçÁΩÆÊò†Â∞Ñ - ${selectedRecord.value.chartName}` : 'ÈÖçÁΩÆÊò†Â∞Ñ'
)

const guideModalTitle = computed(() =>
  selectedRecord.value ? `ÈÖçÁΩÆÊåáÂçó - ${selectedRecord.value.chartName}` : 'ÈÖçÁΩÆÊåáÂçó'
)

// Âä®ÊÄÅÊ†áÈ¢òËÆ°ÁÆóÂ±ûÊÄß
const universalTemplateTitle = computed(() => {
  const fileName = universalTemplateFileName.value
  return fileName ? `ÈÄöÁî®Ê®°ÊùøÂÜÖÂÆπÔºà${fileName}Ôºâ` : 'ÈÄöÁî®Ê®°ÊùøÂÜÖÂÆπ'
})

const echartsDataTitle = computed(() => {
  const chartName = selectedRecord.value?.chartName || ''
  return chartName ? `EChartsÊï∞ÊçÆÁ§∫‰æãÔºà${chartName}Ôºâ` : 'EChartsÊï∞ÊçÆÁ§∫‰æã'
})

const databaseViewTitle = computed(() => {
  const joltSpecFile = selectedRecord.value?.joltSpecFile || ''
  return joltSpecFile ? `Êï∞ÊçÆÂ∫ìËßÜÂõæÊï∞ÊçÆÔºà${joltSpecFile}Ôºâ` : 'Êï∞ÊçÆÂ∫ìËßÜÂõæÊï∞ÊçÆ'
})

// Â≠óÊÆµÂàÜÁªÑËÆ°ÁÆóÂ±ûÊÄß
const groupedFields = computed(() => {
  const groups: Record<string, any[]> = {}

  availableFields.value.forEach(field => {
    const groupName = field.group || 'ÂÖ∂‰ªñ'
    if (!groups[groupName]) {
      groups[groupName] = []
    }
    groups[groupName].push(field)
  })

  return Object.keys(groups).map(name => ({
    name,
    fields: groups[name]
  }))
})

// ÈÖçÁΩÆÊò†Â∞ÑÁã¨Á´ãÁ™óÂè£Ê†∑Âºè
const mappingWindowStyle = computed(() => ({
  top: `${mappingModalPosition.value.top}px`,
  left: `${mappingModalPosition.value.left}px`,
  zIndex: isDragging.value && dragTarget.value === 'mapping' ? 2000 : 1001
}))

// ÈÖçÁΩÆÊåáÂçóÁã¨Á´ãÁ™óÂè£Ê†∑Âºè
const guideWindowStyle = computed(() => ({
  top: `${guideModalPosition.value.top}px`,
  left: `${guideModalPosition.value.left}px`,
  zIndex: isDragging.value && dragTarget.value === 'guide' ? 2000 : 1002
}))



// ‰∫ã‰ª∂Â§ÑÁêÜÊñπÊ≥ï
const onChartSelected = (chartInfo: any) => {
  console.log('üìä [Êò†Â∞ÑÁÆ°ÁêÜ] ÂõæË°®ÈÄâÊã©ÂèòÂåñ:', chartInfo)
  Object.assign(selectedChart, chartInfo)
}

const refreshList = async () => {
  console.log('üîÑ [Êò†Â∞ÑÁÆ°ÁêÜ] Âà∑Êñ∞Êò†Â∞ÑÂàóË°®')
  loading.value = true

  try {
    const listResult = await placeholderMappingApi.getAllMappings()
    console.log('üìã [Êò†Â∞ÑÁÆ°ÁêÜ] APIÂìçÂ∫îÊï∞ÊçÆ:', listResult)

    if (listResult && listResult.mappings) {
      mappingList.value = listResult.mappings
      paginationConfig.total = listResult.totalCount || listResult.mappings.length
      console.log('‚úÖ [Êò†Â∞ÑÁÆ°ÁêÜ] Âà∑Êñ∞ÊàêÂäüÔºåÂÖ±', listResult.totalCount, 'Êù°ËÆ∞ÂΩï')
    } else {
      console.warn('‚ö†Ô∏è [Êò†Â∞ÑÁÆ°ÁêÜ] APIÂìçÂ∫îÊï∞ÊçÆÊ†ºÂºèÂºÇÂ∏∏:', listResult)
      message.warning('Êï∞ÊçÆÊ†ºÂºèÂºÇÂ∏∏')
    }
  } catch (error) {
    console.error('‚ùå [Êò†Â∞ÑÁÆ°ÁêÜ] Âà∑Êñ∞Â§±Ë¥•:', error)
    message.error('Âà∑Êñ∞Â§±Ë¥•')
  } finally {
    loading.value = false
  }
}

const viewMapping = (record: MappingRecord) => {
  console.log('üëÅÔ∏è [Êò†Â∞ÑÁÆ°ÁêÜ] Êü•ÁúãÊò†Â∞Ñ:', record.chartId)
  selectedRecord.value = record
  message.info(`Êü•ÁúãÊò†Â∞Ñ: ${record.chartName}`)
}

const configureMapping = async (record: MappingRecord) => {
  console.log('üîß [Êò†Â∞ÑÁÆ°ÁêÜ] ÈÖçÁΩÆÊò†Â∞Ñ:', record.chartId)
  selectedRecord.value = record

  // Âä†ËΩΩÂç†‰ΩçÁ¨¶ÂíåÁé∞ÊúâÊò†Â∞ÑÈÖçÁΩÆ
  await Promise.all([
    loadPlaceholders(record.chartId),
    loadExistingMappings(record.chartId),
    loadAvailableFields(),
    loadJoltSpecContent(record.chartId)
  ])

  mappingModalVisible.value = true
  console.log('‚úÖ [Êò†Â∞ÑÁÆ°ÁêÜ] ÈÖçÁΩÆÊò†Â∞ÑÊ®°ÊÄÅÊ°ÜÂ∑≤ÊâìÂºÄ')
}

const showConfigGuide = async (record: MappingRecord) => {
  console.log('üìñ [Êò†Â∞ÑÁÆ°ÁêÜ] ÊòæÁ§∫ÈÖçÁΩÆÊåáÂçó:', record.chartId)
  selectedRecord.value = record

  // Âä†ËΩΩÈÄöÁî®Ê®°ÊùøÂÜÖÂÆπ
  await loadUniversalTemplate(record.chartId)

  guideModalVisible.value = true
  console.log('‚úÖ [Êò†Â∞ÑÁÆ°ÁêÜ] ÈÖçÁΩÆÊåáÂçóÊ®°ÊÄÅÊ°ÜÂ∑≤ÊâìÂºÄ')
}

const deleteMapping = (record: MappingRecord) => {
  console.log('üóëÔ∏è [Êò†Â∞ÑÁÆ°ÁêÜ] Âà†Èô§Êò†Â∞Ñ:', record.chartId)
  message.info(`Âà†Èô§Êò†Â∞Ñ: ${record.chartName}`)
}

// È¢ÑËßàÂõæË°®
const previewChart = async (record: MappingRecord) => {
  console.log('üé® [ÂõæË°®È¢ÑËßà] ÂºÄÂßãÈ¢ÑËßàÂõæË°®:', record)

  // ËÆæÁΩÆÂä†ËΩΩÁä∂ÊÄÅ
  buttonLoading.value[record.chartId] = true
  modalLoading.value = true
  previewError.value = ''
  previewChartConfig.value = null

  try {
    // ÂÖàÊµãËØïÂÅ•Â∫∑Ê£ÄÊü•
    console.log('üîç [ÂõæË°®È¢ÑËßà] ÊµãËØïAPIËøûÊé•...')
    try {
      const healthResponse = await twoStageApi.health()
      console.log('‚úÖ [ÂõæË°®È¢ÑËßà] ÂÅ•Â∫∑Ê£ÄÊü•ÊàêÂäü:', healthResponse)
    } catch (healthError) {
      console.error('‚ùå [ÂõæË°®È¢ÑËßà] ÂÅ•Â∫∑Ê£ÄÊü•Â§±Ë¥•:', healthError)
      throw new Error('ÂêéÁ´ØÊúçÂä°‰∏çÂèØÁî®ÔºåËØ∑Ê£ÄÊü•ÊúçÂä°Áä∂ÊÄÅ')
    }

    // Ë∞ÉÁî®‰∏§Èò∂ÊÆµËΩ¨Êç¢È™åËØÅAPI
    console.log('üöÄ [ÂõæË°®È¢ÑËßà] Ë∞ÉÁî®ËΩ¨Êç¢È™åËØÅAPI...')
    const transformResponse = await twoStageApi.validate(record.chartId)
    console.log('üìã [ÂõæË°®È¢ÑËßà] APIÂìçÂ∫î:', transformResponse)

    if (!transformResponse) {
      throw new Error('ÂõæË°®ËΩ¨Êç¢Â§±Ë¥•ÔºöÊó†ÂìçÂ∫îÊï∞ÊçÆ')
    }

    // Â§ÑÁêÜ‰∏çÂêåÁöÑÂìçÂ∫îÊ†ºÂºèÔºåÊèêÂèñEChartsÈÖçÁΩÆ
    let chartConfig
    if (transformResponse.success && transformResponse.data) {
      // Ê†áÂáÜApiResponseÊ†ºÂºè
      const responseData = transformResponse.data
      chartConfig = responseData.echartsConfig || responseData
    } else if (transformResponse.data) {
      // Áõ¥Êé•dataÊ†ºÂºè
      chartConfig = transformResponse.data.echartsConfig || transformResponse.data
    } else {
      // Áõ¥Êé•ÈÖçÁΩÆÊ†ºÂºè
      chartConfig = transformResponse.echartsConfig || transformResponse
    }

    console.log('‚úÖ [ÂõæË°®È¢ÑËßà] ËΩ¨Êç¢ÊàêÂäüÔºåEChartsÈÖçÁΩÆ:', chartConfig)

    // È™åËØÅEChartsÈÖçÁΩÆÁöÑÊúâÊïàÊÄß
    if (!chartConfig || typeof chartConfig !== 'object') {
      throw new Error('Êó†ÊïàÁöÑEChartsÈÖçÁΩÆÊï∞ÊçÆ')
    }

    // ‰øùÂ≠òÈÖçÁΩÆÂπ∂ÊòæÁ§∫È¢ÑËßà
    previewChartConfig.value = chartConfig
    chartPreviewVisible.value = true

    // Á≠âÂæÖDOMÊõ¥Êñ∞ÂêéÊ∏≤ÊüìÂõæË°®
    await nextTick()
    renderPreviewChart(chartConfig)

    message.success('ÂõæË°®È¢ÑËßàÁîüÊàêÊàêÂäü')

  } catch (error: any) {
    console.error('‚ùå [ÂõæË°®È¢ÑËßà] È¢ÑËßàÂ§±Ë¥•:', error)
    previewError.value = error.message || 'ÂõæË°®È¢ÑËßàÂ§±Ë¥•'
    message.error('ÂõæË°®È¢ÑËßàÂ§±Ë¥•: ' + (error.message || 'Êú™Áü•ÈîôËØØ'))

    // ‰∏çË¶ÅÂú®ÈîôËØØÊó∂ÊòæÁ§∫È¢ÑËßàÂºπÁ™ó
    chartPreviewVisible.value = false
    previewChartConfig.value = null
  } finally {
    // Á°Æ‰øùÂä†ËΩΩÁä∂ÊÄÅË¢´ÈáçÁΩÆ
    buttonLoading.value[record.chartId] = false
    modalLoading.value = false
  }
}

// Ê∏≤ÊüìÈ¢ÑËßàÂõæË°®
const renderPreviewChart = (chartConfig: any) => {
  console.log('üé® [ÂõæË°®È¢ÑËßà] ÂºÄÂßãÊ∏≤ÊüìÂõæË°®ÔºåÈÖçÁΩÆ:', chartConfig)

  if (!chartPreviewRef.value) {
    console.error('‚ùå [ÂõæË°®È¢ÑËßà] ÂõæË°®ÂÆπÂô®Êú™ÊâæÂà∞')
    previewError.value = 'ÂõæË°®ÂÆπÂô®Êú™ÊâæÂà∞'
    return
  }

  try {
    // È™åËØÅÂõæË°®ÈÖçÁΩÆ
    if (!chartConfig || typeof chartConfig !== 'object') {
      throw new Error('Êó†ÊïàÁöÑÂõæË°®ÈÖçÁΩÆ')
    }

    // Ê∏ÖÁêÜ‰πãÂâçÁöÑÂÆû‰æã
    if ((chartPreviewRef.value as any)._chartInstance) {
      (chartPreviewRef.value as any)._chartInstance.dispose()
    }

    // ÂàùÂßãÂåñEChartsÂÆû‰æã
    console.log('üîß [ÂõæË°®È¢ÑËßà] ÂàùÂßãÂåñEChartsÂÆû‰æã')
    const previewChartInstance = echarts.init(chartPreviewRef.value)

    // ËÆæÁΩÆÂõæË°®ÈÖçÁΩÆ
    console.log('üìä [ÂõæË°®È¢ÑËßà] ËÆæÁΩÆÂõæË°®ÈÖçÁΩÆ')
    previewChartInstance.setOption(chartConfig, true)

    // ÁõëÂê¨Á™óÂè£Â§ßÂ∞èÂèòÂåñ
    const previewResizeHandler = () => {
      previewChartInstance.resize()
    }
    window.addEventListener('resize', previewResizeHandler)

    // ‰øùÂ≠òÂÆû‰æãÂºïÁî®‰ª•‰æøÊ∏ÖÁêÜ
    ;(chartPreviewRef.value as any)._chartInstance = previewChartInstance
    ;(chartPreviewRef.value as any)._resizeHandler = previewResizeHandler

    console.log('‚úÖ [ÂõæË°®È¢ÑËßà] ÂõæË°®Ê∏≤ÊüìÊàêÂäü')

  } catch (error) {
    console.error('‚ùå [ÂõæË°®È¢ÑËßà] ÂõæË°®Ê∏≤ÊüìÂ§±Ë¥•:', error)
    previewError.value = 'ÂõæË°®Ê∏≤ÊüìÂ§±Ë¥•: ' + (error as Error).message
    message.error('ÂõæË°®Ê∏≤ÊüìÂ§±Ë¥•: ' + (error as Error).message)
  }
}

// Êò†Â∞ÑÈÖçÁΩÆÁõ∏ÂÖ≥ÊñπÊ≥ï
const loadPlaceholders = async (chartId: string) => {
  placeholdersLoading.value = true
  try {
    const placeholderResult = await placeholderMappingApi.getPlaceholders(chartId)
    placeholders.value = placeholderResult.placeholders || []

    // ÂàùÂßãÂåñÊò†Â∞ÑÈÖçÁΩÆÂØπË±°
    placeholders.value.forEach(placeholder => {
      if (!mappingConfigs[placeholder]) {
        mappingConfigs[placeholder] = {
          fieldName: '',
          dataType: '',
          aggregationType: ''
        }
      }
    })

    console.log('üìã [Êò†Â∞ÑÁÆ°ÁêÜ] Âä†ËΩΩÂç†‰ΩçÁ¨¶ÊàêÂäü:', placeholders.value)
  } catch (error) {
    console.error('‚ùå [Êò†Â∞ÑÁÆ°ÁêÜ] Âä†ËΩΩÂç†‰ΩçÁ¨¶Â§±Ë¥•:', error)
    message.error('Âä†ËΩΩÂç†‰ΩçÁ¨¶Â§±Ë¥•')
  } finally {
    placeholdersLoading.value = false
  }
}

const loadExistingMappings = async (chartId: string) => {
  try {
    const mappingResult = await placeholderMappingApi.getMappings(chartId)
    Object.assign(mappingConfigs, mappingResult.mappings || {})
    console.log('üìã [Êò†Â∞ÑÁÆ°ÁêÜ] Âä†ËΩΩÁé∞ÊúâÊò†Â∞ÑÊàêÂäü:', mappingConfigs)
  } catch (error) {
    console.error('‚ùå [Êò†Â∞ÑÁÆ°ÁêÜ] Âä†ËΩΩÁé∞ÊúâÊò†Â∞ÑÂ§±Ë¥•:', error)
  }
}

const loadAvailableFields = async () => {
  try {
    const fieldsResult = await placeholderMappingApi.getAvailableFields()
    availableFields.value = fieldsResult.fields || []
    console.log('üìã [Êò†Â∞ÑÁÆ°ÁêÜ] Âä†ËΩΩÂèØÁî®Â≠óÊÆµÊàêÂäü:', availableFields.value)
  } catch (error) {
    console.error('‚ùå [Êò†Â∞ÑÁÆ°ÁêÜ] Âä†ËΩΩÂèØÁî®Â≠óÊÆµÂ§±Ë¥•:', error)
  }
}

// Âä†ËΩΩJOLTËßÑËåÉÊñá‰ª∂ÂÜÖÂÆπ
const loadJoltSpecContent = async (chartId: string) => {
  if (!chartId) return

  joltSpecLoading.value = true
  try {
    const content = await placeholderMappingApi.getJoltSpecContent(chartId)
    joltSpecContent.value = content
    console.log('‚úÖ [Êò†Â∞ÑÁÆ°ÁêÜ] JOLTËßÑËåÉÊñá‰ª∂Âä†ËΩΩÊàêÂäü:', chartId)
  } catch (error) {
    console.error('‚ùå [Êò†Â∞ÑÁÆ°ÁêÜ] Âä†ËΩΩJOLTËßÑËåÉÊñá‰ª∂Â§±Ë¥•:', error)
    message.error('Âä†ËΩΩJOLTËßÑËåÉÊñá‰ª∂Â§±Ë¥•')
    joltSpecContent.value = null
  } finally {
    joltSpecLoading.value = false
  }
}

// Âä†ËΩΩÈÄöÁî®Ê®°ÊùøÂÜÖÂÆπ
const loadUniversalTemplate = async (chartId: string) => {
  if (!chartId) return

  universalTemplateLoading.value = true
  universalTemplateError.value = null
  try {
    console.log('üîÑ [ÈÖçÁΩÆÊåáÂçó] ÂºÄÂßãÂä†ËΩΩÈÄöÁî®Ê®°Êùø:', chartId)
    const response = await universalTemplateApi.getByChartType(chartId)
    universalTemplateContent.value = response.content
    universalTemplateFileName.value = response.fileName || ''
    console.log('‚úÖ [ÈÖçÁΩÆÊåáÂçó] ÈÄöÁî®Ê®°ÊùøÂä†ËΩΩÊàêÂäü:', chartId, response)
  } catch (error) {
    console.error('‚ùå [ÈÖçÁΩÆÊåáÂçó] Âä†ËΩΩÈÄöÁî®Ê®°ÊùøÂ§±Ë¥•:', error)
    universalTemplateError.value = 'Âä†ËΩΩÈÄöÁî®Ê®°ÊùøÂ§±Ë¥•'
    universalTemplateContent.value = null
    universalTemplateFileName.value = ''
    message.error('Âä†ËΩΩÈÄöÁî®Ê®°ÊùøÂ§±Ë¥•')
  } finally {
    universalTemplateLoading.value = false
  }
}

// Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø
const copyToClipboard = async (text: string) => {
  try {
    await navigator.clipboard.writeText(text)
    message.success('Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø')
  } catch (error) {
    console.error('Â§çÂà∂Â§±Ë¥•:', error)
    message.error('Â§çÂà∂Â§±Ë¥•')
  }
}

const isMapped = (placeholder: string) => {
  return mappingConfigs[placeholder]?.fieldName
}

// Êò†Â∞ÑÈÖçÁΩÆÁöÑgetterÂíåsetterÊñπÊ≥ï
const getMappingFieldName = (placeholder: string) => {
  return mappingConfigs[placeholder]?.fieldName || ''
}

const updateMappingFieldName = (placeholder: string, value: string) => {
  if (!mappingConfigs[placeholder]) {
    mappingConfigs[placeholder] = {}
  }
  mappingConfigs[placeholder].fieldName = value
  onMappingChange(placeholder)
}

const getMappingDataType = (placeholder: string) => {
  return mappingConfigs[placeholder]?.dataType || ''
}

const updateMappingDataType = (placeholder: string, value: string) => {
  if (!mappingConfigs[placeholder]) {
    mappingConfigs[placeholder] = {}
  }
  mappingConfigs[placeholder].dataType = value
  onMappingChange(placeholder)
}

const getMappingAggregationType = (placeholder: string) => {
  return mappingConfigs[placeholder]?.aggregationType || ''
}

const updateMappingAggregationType = (placeholder: string, value: string) => {
  if (!mappingConfigs[placeholder]) {
    mappingConfigs[placeholder] = {}
  }
  mappingConfigs[placeholder].aggregationType = value
  onMappingChange(placeholder)
}

const onMappingChange = (placeholder: string) => {
  console.log('üîÑ [Êò†Â∞ÑÁÆ°ÁêÜ] Êò†Â∞ÑÂèòÂåñ:', placeholder, mappingConfigs[placeholder])
}

const clearMapping = (placeholder: string) => {
  delete mappingConfigs[placeholder]
  console.log('üóëÔ∏è [Êò†Â∞ÑÁÆ°ÁêÜ] Ê∏ÖÈô§Êò†Â∞Ñ:', placeholder)
}

const saveMappingConfig = async () => {
  if (!selectedRecord.value) return

  savingConfig.value = true
  try {
    // ËøáÊª§Âá∫Â∑≤ÈÖçÁΩÆÁöÑÊò†Â∞Ñ
    const validMappings = Object.fromEntries(
      Object.entries(mappingConfigs).filter(([_, config]: [string, any]) => config.fieldName)
    )

    await placeholderMappingApi.configureMappings(selectedRecord.value.chartId, validMappings)
    message.success('Êò†Â∞ÑÈÖçÁΩÆ‰øùÂ≠òÊàêÂäü')
    mappingModalVisible.value = false
    await refreshList()
  } catch (error) {
    console.error('‚ùå [Êò†Â∞ÑÁÆ°ÁêÜ] ‰øùÂ≠òÊò†Â∞ÑÈÖçÁΩÆÂ§±Ë¥•:', error)
    message.error('‰øùÂ≠òÊò†Â∞ÑÈÖçÁΩÆÂ§±Ë¥•')
  } finally {
    savingConfig.value = false
  }
}

// ÊãñÊãΩÂäüËÉΩÂÆûÁé∞
const startDrag = (event: MouseEvent, modalType: string) => {
  event.preventDefault()
  event.stopPropagation()

  isDragging.value = true
  dragTarget.value = modalType

  // Ê∑ªÂä†ÊãñÊãΩÁä∂ÊÄÅÁöÑËßÜËßâÂèçÈ¶à
  document.body.classList.add('dragging')

  console.log('üñ±Ô∏è [ÊãñÊãΩ] ÂºÄÂßãÊãñÊãΩ:', modalType, 'ÂàùÂßã‰ΩçÁΩÆ:', event.clientX, event.clientY)

  const startX = event.clientX
  const startY = event.clientY

  const currentPosition = modalType === 'mapping' ? mappingModalPosition.value : guideModalPosition.value
  const startTop = currentPosition.top
  const startLeft = currentPosition.left

  console.log('üìç [ÊãñÊãΩ] Ê®°ÊÄÅÊ°ÜÂΩìÂâç‰ΩçÁΩÆ:', { startTop, startLeft })

  const handleMouseMove = (e: MouseEvent) => {
    if (!isDragging.value) return

    const deltaX = e.clientX - startX
    const deltaY = e.clientY - startY

    // Ëé∑ÂèñËßÜÂè£Â∞∫ÂØ∏
    const viewportWidth = window.innerWidth
    const viewportHeight = window.innerHeight

    // Ëé∑ÂèñÂÆûÈôÖÁ™óÂè£Â∞∫ÂØ∏
    const windowElement = document.querySelector(
      modalType === 'mapping' ? '.mapping-floating-window' : '.guide-floating-window'
    ) as HTMLElement

    let elementWidth = modalType === 'mapping' ? 1000 : 900  // ÈÖçÁΩÆÊåáÂçóÁ™óÂè£‰ºòÂåñ‰∏∫900px
    let elementHeight = 500

    if (windowElement) {
      const rect = windowElement.getBoundingClientRect()
      elementWidth = rect.width
      elementHeight = rect.height
    }

    // ËÆ°ÁÆóÊñ∞‰ΩçÁΩÆ - ÂÖÅËÆ∏Êõ¥ÁÅµÊ¥ªÁöÑËæπÁïå
    // Â∑¶ËæπÁïåÔºöÂÖÅËÆ∏ÊãñÊãΩÂà∞Ë¥üÂùêÊ†áÔºå‰ΩÜ‰øùÁïôËá≥Â∞ë100pxÂèØËßÅÂå∫Âüü
    const minLeft = -(elementWidth - 100)
    // Âè≥ËæπÁïåÔºöÂÖÅËÆ∏ÊãñÊãΩÂà∞ËßÜÂè£Âè≥‰æßÔºå‰ΩÜ‰øùÁïôËá≥Â∞ë100pxÂèØËßÅÂå∫Âüü
    const maxLeft = viewportWidth - 100
    // ‰∏äËæπÁïåÔºö‰∏çËÉΩË∂ÖÂá∫ËßÜÂè£È°∂ÈÉ®
    const minTop = 0
    // ‰∏ãËæπÁïåÔºöÂÖÅËÆ∏ÊãñÊãΩÂà∞ËßÜÂè£Â∫ïÈÉ®Ôºå‰ΩÜ‰øùÁïôËá≥Â∞ë50pxÂèØËßÅÂå∫Âüü
    const maxTop = viewportHeight - 50

    const newTop = Math.max(minTop, Math.min(maxTop, startTop + deltaY))
    const newLeft = Math.max(minLeft, Math.min(maxLeft, startLeft + deltaX))

    const newPosition = { top: newTop, left: newLeft }

    // Êõ¥Êñ∞‰ΩçÁΩÆ
    if (modalType === 'mapping') {
      mappingModalPosition.value = newPosition
    } else {
      guideModalPosition.value = newPosition
    }

    // Ë∞ÉËØï‰ø°ÊÅØ
    if (Math.abs(deltaX) % 30 === 0 || Math.abs(deltaY) % 30 === 0) {
      console.log('üîÑ [ÊãñÊãΩ] ‰ΩçÁΩÆÊõ¥Êñ∞:', {
        modalType,
        delta: { deltaX, deltaY },
        newPosition,
        boundaries: {
          viewport: { width: viewportWidth, height: viewportHeight },
          element: { width: elementWidth, height: elementHeight },
          limits: { minLeft, maxLeft, minTop, maxTop }
        }
      })
    }
  }

  const handleMouseUp = () => {
    const finalPosition = modalType === 'mapping' ? mappingModalPosition.value : guideModalPosition.value
    console.log('üõë [ÊãñÊãΩ] ÁªìÊùüÊãñÊãΩ:', modalType, 'ÊúÄÁªà‰ΩçÁΩÆ:', finalPosition)

    // ÁßªÈô§ÊãñÊãΩÁä∂ÊÄÅÁöÑËßÜËßâÂèçÈ¶à
    document.body.classList.remove('dragging')

    isDragging.value = false
    dragTarget.value = ''
    document.removeEventListener('mousemove', handleMouseMove)
    document.removeEventListener('mouseup', handleMouseUp)
  }

  document.addEventListener('mousemove', handleMouseMove)
  document.addEventListener('mouseup', handleMouseUp)
}

// Á™óÂè£ÁÇπÂáªÁΩÆÈ°∂ÂäüËÉΩ
const bringToFront = (windowType: string) => {
  console.log('üîù [Á™óÂè£] ÁΩÆÈ°∂Á™óÂè£:', windowType)

  const mappingWindow = document.querySelector('.mapping-floating-window')
  const guideWindow = document.querySelector('.guide-floating-window')

  if (windowType === 'mapping' && mappingWindow) {
    (mappingWindow as HTMLElement).style.zIndex = '1003'
    if (guideWindow) {
      (guideWindow as HTMLElement).style.zIndex = '1002'
    }
  } else if (windowType === 'guide' && guideWindow) {
    (guideWindow as HTMLElement).style.zIndex = '1003'
    if (mappingWindow) {
      (mappingWindow as HTMLElement).style.zIndex = '1001'
    }
  }
}

// ÈÖçÁΩÆÊåáÂçóÂÜÖÂÆπÁîüÊàê
const getOfficialExample = () => {
  if (!selectedRecord.value) return 'ËØ∑ÈÄâÊã©ÂõæË°®'

  const examples: Record<string, string> = {
    'ÊäòÁ∫øÂõæ': `{
  "title": {
    "text": "\${chart_title}"
  },
  "tooltip": {
    "trigger": "axis"
  },
  "legend": {
    "data": ["\${series_1_name}"]
  },
  "xAxis": {
    "type": "category",
    "data": \${categories}
  },
  "yAxis": {
    "type": "value"
  },
  "series": [{
    "name": "\${series_1_name}",
    "type": "line",
    "data": \${series_1_data}
  }]
}`,
    'Êü±Áä∂Âõæ': `{
  "title": {
    "text": "\${chart_title}"
  },
  "tooltip": {
    "trigger": "axis"
  },
  "xAxis": {
    "type": "category",
    "data": \${categories}
  },
  "yAxis": {
    "type": "value"
  },
  "series": [{
    "name": "\${series_1_name}",
    "type": "bar",
    "data": \${series_1_data}
  }]
}`,
    'È•ºÂõæ': `{
  "title": {
    "text": "\${chart_title}",
    "left": "center"
  },
  "tooltip": {
    "trigger": "item"
  },
  "legend": {
    "orient": "vertical",
    "left": "left"
  },
  "series": [{
    "name": "\${chart_title}",
    "type": "pie",
    "radius": "50%",
    "data": \${pie_data},
    "emphasis": {
      "itemStyle": {
        "shadowBlur": 10,
        "shadowOffsetX": 0,
        "shadowColor": "rgba(0, 0, 0, 0.5)"
      }
    }
  }]
}`,
    'Èõ∑ËææÂõæ': `{
  "title": {
    "text": "\${chart_title}"
  },
  "tooltip": {},
  "legend": {
    "data": ["Êï∞ÊçÆÁ≥ªÂàó"]
  },
  "radar": {
    "indicator": \${radar_indicators}
  },
  "series": [{
    "name": "Êï∞ÊçÆÂØπÊØî",
    "type": "radar",
    "data": \${radar_data}
  }]
}`,
    '‰ª™Ë°®Áõò': `{
  "title": {
    "text": "\${chart_title}"
  },
  "series": [{
    "name": "‰ª™Ë°®Áõò",
    "type": "gauge",
    "detail": { "formatter": "{value}%" },
    "data": [{
      "value": \${gauge_value},
      "name": "ÂÆåÊàêÁéá"
    }]
  }]
}`
  }

  return examples[selectedRecord.value.chartType] || 'ÊöÇÊó†Á§∫‰æã'
}

const getStructureDescription = () => {
  if (!selectedRecord.value) return []

  const descriptions: Record<string, string[]> = {
    'ÊäòÁ∫øÂõæ': [
      'title: ÂõæË°®Ê†áÈ¢òÈÖçÁΩÆÔºåÊîØÊåÅÊñáÊú¨ÂíåÊ†∑ÂºèËÆæÁΩÆ',
      'xAxis: XËΩ¥ÈÖçÁΩÆÔºåÈÄöÂ∏∏‰∏∫Á±ªÁõÆËΩ¥ÔºåÊòæÁ§∫ÂàÜÁ±ªÊï∞ÊçÆ',
      'yAxis: YËΩ¥ÈÖçÁΩÆÔºåÈÄöÂ∏∏‰∏∫Êï∞ÂÄºËΩ¥ÔºåÊòæÁ§∫Êï∞ÂÄºËåÉÂõ¥',
      'series: Êï∞ÊçÆÁ≥ªÂàóÈÖçÁΩÆÔºåÂåÖÂê´Êï∞ÊçÆÁÇπÂíåÊ†∑Âºè',
      'tooltip: ÊèêÁ§∫Ê°ÜÈÖçÁΩÆÔºåÈº†Ê†áÊÇ¨ÂÅúÊó∂ÊòæÁ§∫ËØ¶ÁªÜ‰ø°ÊÅØ'
    ],
    'Êü±Áä∂Âõæ': [
      'title: ÂõæË°®Ê†áÈ¢òÈÖçÁΩÆ',
      'xAxis: XËΩ¥Á±ªÁõÆÈÖçÁΩÆÔºåÊòæÁ§∫ÂàÜÁ±ªÊ†áÁ≠æ',
      'yAxis: YËΩ¥Êï∞ÂÄºÈÖçÁΩÆÔºåÊòæÁ§∫Êï∞ÂÄºÂàªÂ∫¶',
      'series: Êü±Áä∂Êï∞ÊçÆÁ≥ªÂàóÔºåtypeËÆæÁΩÆ‰∏∫"bar"',
      'tooltip: ‰∫§‰∫íÊèêÁ§∫ÈÖçÁΩÆ'
    ],
    'È•ºÂõæ': [
      'title: ÂõæË°®Ê†áÈ¢òÔºåÈÄöÂ∏∏Â±Ö‰∏≠ÊòæÁ§∫',
      'series: È•ºÂõæÊï∞ÊçÆÁ≥ªÂàóÔºåtypeËÆæÁΩÆ‰∏∫"pie"',
      'radius: È•ºÂõæÂçäÂæÑËÆæÁΩÆÔºåÊîØÊåÅÁôæÂàÜÊØîÊàñÂÉèÁ¥†ÂÄº',
      'data: È•ºÂõæÊï∞ÊçÆÔºåÂåÖÂê´nameÂíåvalueÂ≠óÊÆµ',
      'legend: Âõæ‰æãÈÖçÁΩÆÔºåÊòæÁ§∫Êï∞ÊçÆÈ°πËØ¥Êòé'
    ],
    'Èõ∑ËææÂõæ': [
      'radar: Èõ∑ËææÂõæÂùêÊ†áÁ≥ªÈÖçÁΩÆ',
      'indicator: Èõ∑ËææÂõæÊåáÊ†áÈÖçÁΩÆÔºåÂÆö‰πâÂêÑ‰∏™Áª¥Â∫¶',
      'series: Èõ∑ËææÂõæÊï∞ÊçÆÁ≥ªÂàóÔºåtypeËÆæÁΩÆ‰∏∫"radar"',
      'data: Èõ∑ËææÂõæÊï∞ÊçÆÔºåÂ§öÁª¥Â∫¶Êï∞ÂÄºÊï∞ÁªÑ'
    ],
    '‰ª™Ë°®Áõò': [
      'series: ‰ª™Ë°®ÁõòÊï∞ÊçÆÁ≥ªÂàóÔºåtypeËÆæÁΩÆ‰∏∫"gauge"',
      'data: ‰ª™Ë°®ÁõòÊï∞ÊçÆÔºåÂåÖÂê´valueÂíåname',
      'detail: ËØ¶ÁªÜ‰ø°ÊÅØÈÖçÁΩÆÔºåÂ¶ÇÊï∞ÂÄºÊ†ºÂºèÂåñ',
      'min/max: ‰ª™Ë°®ÁõòÊï∞ÂÄºËåÉÂõ¥ËÆæÁΩÆ'
    ]
  }

  return descriptions[selectedRecord.value.chartType] || ['ÊöÇÊó†ÊèèËø∞']
}

// Ëé∑ÂèñÂèòÈáèËØ¥Êòé
const getVariableDescription = () => {
  if (!selectedRecord.value) return []

  const variables: Record<string, string[]> = {
    'ÊäòÁ∫øÂõæ': [
      '${chart_title}: ÂõæË°®Ê†áÈ¢òÊñáÊú¨ÔºåÊòæÁ§∫Âú®ÂõæË°®È°∂ÈÉ®',
      '${categories}: XËΩ¥ÂàÜÁ±ªÊï∞ÊçÆÔºåÈÄöÂ∏∏‰∏∫Êó∂Èó¥ÊàñÂàÜÁ±ªÊ†áÁ≠æ',
      '${series_1_name}: Á¨¨‰∏Ä‰∏™Êï∞ÊçÆÁ≥ªÂàóÁöÑÂêçÁß∞',
      '${series_1_data}: Á¨¨‰∏Ä‰∏™Êï∞ÊçÆÁ≥ªÂàóÁöÑÊï∞ÂÄºÊï∞ÁªÑ',
      '${series_2_name}: Á¨¨‰∫å‰∏™Êï∞ÊçÆÁ≥ªÂàóÁöÑÂêçÁß∞ÔºàÂ¶ÇÊûúÊúâÔºâ',
      '${series_2_data}: Á¨¨‰∫å‰∏™Êï∞ÊçÆÁ≥ªÂàóÁöÑÊï∞ÂÄºÊï∞ÁªÑÔºàÂ¶ÇÊûúÊúâÔºâ'
    ],
    'Êü±Áä∂Âõæ': [
      '${chart_title}: ÂõæË°®Ê†áÈ¢òÊñáÊú¨',
      '${categories}: XËΩ¥ÂàÜÁ±ªÊ†áÁ≠æ',
      '${series_1_name}: Êï∞ÊçÆÁ≥ªÂàóÂêçÁß∞',
      '${series_1_data}: Êü±Áä∂ÂõæÊï∞ÂÄºÊï∞ÊçÆ',
      '${series_2_name}: Á¨¨‰∫å‰∏™Á≥ªÂàóÂêçÁß∞ÔºàÂ¶ÇÊûúÊúâÔºâ',
      '${series_2_data}: Á¨¨‰∫å‰∏™Á≥ªÂàóÊï∞ÊçÆÔºàÂ¶ÇÊûúÊúâÔºâ'
    ],
    'È•ºÂõæ': [
      '${chart_title}: È•ºÂõæÊ†áÈ¢ò',
      '${pie_data}: È•ºÂõæÊï∞ÊçÆÔºåÂåÖÂê´nameÂíåvalueÂ≠óÊÆµÁöÑÂØπË±°Êï∞ÁªÑ'
    ],
    'Èõ∑ËææÂõæ': [
      '${chart_title}: Èõ∑ËææÂõæÊ†áÈ¢ò',
      '${radar_indicators}: Èõ∑ËææÂõæÊåáÊ†áÈÖçÁΩÆÔºåÂÆö‰πâÂêÑ‰∏™Áª¥Â∫¶',
      '${radar_data}: Èõ∑ËææÂõæÊï∞ÊçÆÔºåÂ§öÁª¥Â∫¶Êï∞ÂÄºÊï∞ÁªÑ'
    ],
    '‰ª™Ë°®Áõò': [
      '${chart_title}: ‰ª™Ë°®ÁõòÊ†áÈ¢ò',
      '${gauge_value}: ‰ª™Ë°®ÁõòÊòæÁ§∫ÁöÑÊï∞ÂÄº'
    ]
  }

  return variables[selectedRecord.value.chartType] || ['ÊöÇÊó†ÂèòÈáèËØ¥Êòé']
}

// Ëé∑ÂèñÊï∞ÊçÆÂ∫ìËßÜÂõæÊï∞ÊçÆ
const getDatabaseViewData = () => {
  if (!selectedRecord.value) return '{}'

  const databaseData: Record<string, string> = {
    'ÊäòÁ∫øÂõæ': `{
  "id": 1001,
  "year": "2024",
  "month": "03",
  "date": "2024-03-15",
  "category": "ÁîµÂ≠ê‰∫ßÂìÅ",
  "channel": "Á∫ø‰∏ä",
  "product": "iPhone 15",
  "region": "Âçé‰∏ú",
  "amount": 12500.50,
  "quantity": 25,
  "percentage": 35.8,
  "salesman": "Âº†‰∏â"
}`,
    'Êü±Áä∂Âõæ': `{
  "id": 1002,
  "year": "2024",
  "month": "03",
  "date": "2024-03-15",
  "category": "ÊúçË£Ö",
  "channel": "Á∫ø‰∏ã",
  "product": "NikeËøêÂä®Èûã",
  "region": "ÂçéÂåó",
  "amount": 8900.00,
  "quantity": 45,
  "percentage": 28.5,
  "salesman": "ÊùéÂõõ"
}`,
    'È•ºÂõæ': `{
  "id": 1003,
  "year": "2024",
  "month": "03",
  "date": "2024-03-15",
  "category": "È£üÂìÅ",
  "channel": "ÁßªÂä®Á´Ø",
  "product": "ÊòüÂ∑¥ÂÖãÂíñÂï°",
  "region": "ÂçéÂçó",
  "amount": 3200.75,
  "quantity": 120,
  "percentage": 15.2,
  "salesman": "Áéã‰∫î"
}`,
    'Èõ∑ËææÂõæ': `{
  "id": 1004,
  "year": "2024",
  "month": "03",
  "date": "2024-03-15",
  "category": "ÂÆ∂Â±Ö",
  "channel": "ÁîµËØùÈîÄÂîÆ",
  "product": "Êô∫ËÉΩÈü≥ÁÆ±",
  "region": "Âçé‰∏≠",
  "amount": 5600.25,
  "quantity": 18,
  "percentage": 42.3,
  "salesman": "ËµµÂÖ≠"
}`,
    '‰ª™Ë°®Áõò': `{
  "id": 1005,
  "year": "2024",
  "month": "03",
  "date": "2024-03-15",
  "category": "Âõæ‰π¶",
  "channel": "Áõ¥ÈîÄ",
  "product": "ÊäÄÊúØÁ±ªÂõæ‰π¶",
  "region": "Ë•øÂåó",
  "amount": 1850.00,
  "quantity": 75,
  "percentage": 68.9,
  "salesman": "Èí±‰∏É"
}`
  }

  return databaseData[selectedRecord.value.chartType] || databaseData['ÊäòÁ∫øÂõæ']
}

const getTransformationBefore = () => {
  return `{
  "virtualDatabase": {
    "chartData": [
      {
        "id": 1,
        "year": "2024",
        "month": "1Êúà",
        "category": "ÈîÄÂîÆÊï∞ÊçÆ",
        "channel": "Á∫ø‰∏ä",
        "product": "‰∫ßÂìÅA",
        "amount": 12500.50,
        "quantity": 100
      }
    ]
  }
}`
}

const getTransformationAfter = () => {
  if (!selectedRecord.value) return 'ËØ∑ÈÄâÊã©ÂõæË°®'

  // Ê†πÊçÆÂõæË°®IDËøîÂõûÂØπÂ∫îÁöÑEChartsÊï∞ÊçÆÁ§∫‰æã
  const chartExamples: Record<string, string> = {
    // ÊäòÁ∫øÂõæÁ±ªÂûã
    'smooth_line_chart': `{
  "xAxis": {
    "type": "category",
    "data": ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"]
  },
  "yAxis": {
    "type": "value"
  },
  "series": [{
    "data": [100, 300, 150, 400, 200, 350, 250],
    "type": "line",
    "smooth": true,
    "symbol": "circle",
    "symbolSize": 6,
    "lineStyle": {
      "width": 2
    }
  }]
}`,
    'basic_line_chart': `{
  "xAxis": {
    "type": "category",
    "data": ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"]
  },
  "yAxis": {
    "type": "value"
  },
  "series": [{
    "data": [100, 300, 150, 400, 200, 350, 250],
    "type": "line",
    "smooth": false,
    "symbol": "circle",
    "symbolSize": 6,
    "lineStyle": {
      "width": 2
    }
  }]
}`,
    // Êü±Áä∂ÂõæÁ±ªÂûã
    'basic_bar_chart': `{
  "xAxis": {
    "type": "category",
    "data": ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"]
  },
  "yAxis": {
    "type": "value"
  },
  "series": [{
    "data": [120, 200, 150, 80, 70, 110, 130],
    "type": "bar"
  }]
}`,
    // È•ºÂõæÁ±ªÂûã
    'basic_pie_chart': `{
  "title": {
    "text": "ËÆøÈóÆÊù•Ê∫ê",
    "left": "center"
  },
  "tooltip": {
    "trigger": "item"
  },
  "series": [{
    "type": "pie",
    "radius": "50%",
    "data": [
      { "value": 1048, "name": "ÊêúÁ¥¢ÂºïÊìé" },
      { "value": 735, "name": "Áõ¥Êé•ËÆøÈóÆ" },
      { "value": 580, "name": "ÈÇÆ‰ª∂Ëê•ÈîÄ" },
      { "value": 484, "name": "ËÅîÁõüÂπøÂëä" },
      { "value": 300, "name": "ËßÜÈ¢ëÂπøÂëä" }
    ]
  }]
}`,
    // Èõ∑ËææÂõæÁ±ªÂûã
    'basic_radar_chart': `{
  "title": {
    "text": "Âü∫Á°ÄÈõ∑ËææÂõæ"
  },
  "radar": {
    "indicator": [
      { "name": "ÈîÄÂîÆ", "max": 6500 },
      { "name": "ÁÆ°ÁêÜ", "max": 16000 },
      { "name": "‰ø°ÊÅØÊäÄÊúØ", "max": 30000 },
      { "name": "ÂÆ¢Êúç", "max": 38000 },
      { "name": "Á†îÂèë", "max": 52000 },
      { "name": "Â∏ÇÂú∫", "max": 25000 }
    ]
  },
  "series": [{
    "type": "radar",
    "data": [{
      "value": [4200, 3000, 20000, 35000, 50000, 18000],
      "name": "È¢ÑÁÆóÂàÜÈÖç"
    }]
  }]
}`,
    // ‰ª™Ë°®ÁõòÁ±ªÂûã
    'basic_gauge_chart': `{
  "series": [{
    "type": "gauge",
    "data": [{
      "value": 75,
      "name": "ÂÆåÊàêÁéá"
    }]
  }]
}`
  }

  // ‰ºòÂÖàÊ†πÊçÆÂõæË°®IDÂåπÈÖçÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàôÊ†πÊçÆÂõæË°®Á±ªÂûãÂåπÈÖç
  return chartExamples[selectedRecord.value.chartId] ||
         chartExamples[selectedRecord.value.chartType] ||
         chartExamples['smooth_line_chart']
}

const getPlaceholderList = () => {
  if (!selectedRecord.value) return []

  const placeholders: Record<string, Array<{name: string, description: string, color: string}>> = {
    'ÊäòÁ∫øÂõæ': [
      { name: '${chart_title}', description: 'ÂõæË°®Ê†áÈ¢ò', color: 'blue' },
      { name: '${categories}', description: 'XËΩ¥ÂàÜÁ±ªÊï∞ÊçÆ', color: 'green' },
      { name: '${series_1_name}', description: 'Á≥ªÂàóÂêçÁß∞', color: 'orange' },
      { name: '${series_1_data}', description: 'Á≥ªÂàóÊï∞ÊçÆ', color: 'purple' }
    ],
    'Êü±Áä∂Âõæ': [
      { name: '${chart_title}', description: 'ÂõæË°®Ê†áÈ¢ò', color: 'blue' },
      { name: '${categories}', description: 'XËΩ¥ÂàÜÁ±ªÊï∞ÊçÆ', color: 'green' },
      { name: '${series_1_name}', description: 'Á≥ªÂàóÂêçÁß∞', color: 'orange' },
      { name: '${series_1_data}', description: 'Á≥ªÂàóÊï∞ÊçÆ', color: 'purple' }
    ],
    'È•ºÂõæ': [
      { name: '${chart_title}', description: 'ÂõæË°®Ê†áÈ¢ò', color: 'blue' },
      { name: '${pie_data}', description: 'È•ºÂõæÊï∞ÊçÆ', color: 'red' }
    ],
    'Èõ∑ËææÂõæ': [
      { name: '${chart_title}', description: 'ÂõæË°®Ê†áÈ¢ò', color: 'blue' },
      { name: '${radar_indicators}', description: 'Èõ∑ËææÂõæÊåáÊ†á', color: 'cyan' },
      { name: '${radar_data}', description: 'Èõ∑ËææÂõæÊï∞ÊçÆ', color: 'magenta' }
    ],
    '‰ª™Ë°®Áõò': [
      { name: '${chart_title}', description: 'ÂõæË°®Ê†áÈ¢ò', color: 'blue' },
      { name: '${gauge_value}', description: '‰ª™Ë°®ÁõòÊï∞ÂÄº', color: 'gold' }
    ]
  }

  return placeholders[selectedRecord.value.chartType] || []
}

// ÊòæÁ§∫ÂõæË°®È¢ÑËßà
const showChartPreview = async () => {
  console.log('üîç [ÂõæË°®È¢ÑËßà] ÂºÄÂßãÊòæÁ§∫È¢ÑËßàÔºåÂΩìÂâçËÆ∞ÂΩï:', selectedRecord.value)

  // Ëé∑ÂèñÁ§∫‰æãÊï∞ÊçÆ
  const sampleData = getSampleChartData()
  console.log('üìä [ÂõæË°®È¢ÑËßà] Ëé∑ÂèñÂà∞Á§∫‰æãÊï∞ÊçÆ:', sampleData)

  // ÊòæÁ§∫ÂºπÊ°ÜÔºàÂÖàÊòæÁ§∫ÂºπÊ°ÜÔºåÂÜçËÆæÁΩÆÊï∞ÊçÆÔºâ
  chartPreviewVisible.value = true
  modalLoading.value = true

  try {
    // Á≠âÂæÖÂºπÊ°ÜDOMÊ∏≤ÊüìÂÆåÊàê
    await nextTick()

    // ËÆæÁΩÆÈ¢ÑËßàÊï∞ÊçÆÔºàÂú®ÂºπÊ°ÜÊòæÁ§∫ÂêéËÆæÁΩÆÔºâ
    chartPreviewData.value = sampleData

    // ÂÜçÊ¨°Á≠âÂæÖÊï∞ÊçÆÊõ¥Êñ∞ÂêéÁöÑDOMÊ∏≤Êüì
    await nextTick()

    // ‰ΩøÁî®Êõ¥ÈïøÁöÑÂª∂ËøüÂíåÈáçËØïÊú∫Âà∂
    const initChart = () => {
      console.log('üîç [ÂõæË°®È¢ÑËßà] Ê£ÄÊü•DOMÂÖÉÁ¥†:', chartPreviewRef.value)
      console.log('üîç [ÂõæË°®È¢ÑËßà] Ê£ÄÊü•Êï∞ÊçÆ:', chartPreviewData.value)
      console.log('üîç [ÂõæË°®È¢ÑËßà] ÂºπÊ°ÜÂèØËßÅÁä∂ÊÄÅ:', chartPreviewVisible.value)
      console.log('üîç [ÂõæË°®È¢ÑËßà] Âä†ËΩΩÁä∂ÊÄÅ:', modalLoading.value)

      if (chartPreviewRef.value && chartPreviewData.value) {
        console.log('üé® [ÂõæË°®È¢ÑËßà] ÂºÄÂßãÂàùÂßãÂåñEChartsÂÆû‰æã')
        console.log('üé® [ÂõæË°®È¢ÑËßà] DOMÂÖÉÁ¥†Â∞∫ÂØ∏:', {
          width: chartPreviewRef.value.offsetWidth,
          height: chartPreviewRef.value.offsetHeight
        })

        try {
          // ÂàõÂª∫EChartsÂÆû‰æã
          const modalChartInstance = echarts.init(chartPreviewRef.value)

          // ËÆæÁΩÆÂõæË°®ÈÖçÁΩÆ
          modalChartInstance.setOption(chartPreviewData.value)

          // ÈáçË¶ÅÔºöÊâãÂä®Ë∞ÉÁî®resizeÁ°Æ‰øùÂõæË°®Â∞∫ÂØ∏Ê≠£Á°Æ
          setTimeout(() => {
            modalChartInstance.resize()
            console.log('üîÑ [ÂõæË°®È¢ÑËßà] ÂõæË°®Â∞∫ÂØ∏Â∑≤ÈáçÊñ∞ËÆ°ÁÆó')
          }, 100)

          // ÁõëÂê¨Á™óÂè£Â§ßÂ∞èÂèòÂåñ
          const modalResizeHandler = () => {
            modalChartInstance.resize()
          }
          window.addEventListener('resize', modalResizeHandler)

          // ‰øùÂ≠òÂÆû‰æãÂºïÁî®‰ª•‰æøÊ∏ÖÁêÜ
          ;(chartPreviewRef.value as any)._chartInstance = modalChartInstance
          ;(chartPreviewRef.value as any)._resizeHandler = modalResizeHandler

          console.log('‚úÖ [ÂõæË°®È¢ÑËßà] È¢ÑËßàÁîüÊàêÊàêÂäü:', selectedRecord.value?.chartType)
          message.success('ÂõæË°®È¢ÑËßàÁîüÊàêÊàêÂäü')
          modalLoading.value = false
        } catch (chartError) {
          console.error('‚ùå [ÂõæË°®È¢ÑËßà] EChartsÂàùÂßãÂåñÂ§±Ë¥•:', chartError)
          message.error('ÂõæË°®ÂàùÂßãÂåñÂ§±Ë¥•')
          modalLoading.value = false
        }
      } else {
        console.error('‚ùå [ÂõæË°®È¢ÑËßà] DOMÂÖÉÁ¥†ÊàñÊï∞ÊçÆÊú™ÂáÜÂ§áÂ•ΩÔºåÈáçËØï‰∏≠...')
        console.log('üîç [ÂõæË°®È¢ÑËßà] ÈáçËØïËØ¶ÊÉÖ:', {
          hasRef: !!chartPreviewRef.value,
          hasData: !!chartPreviewData.value,
          modalVisible: chartPreviewVisible.value,
          loading: modalLoading.value
        })

        // ÈáçËØïÊú∫Âà∂ÔºöÊúÄÂ§öÈáçËØï5Ê¨°ÔºåÂª∂ÈïøÈó¥Èöî
        const retryCount = (window as any).chartRetryCount || 0
        if (retryCount < 5) {
          (window as any).chartRetryCount = retryCount + 1
          setTimeout(initChart, 500) // Âª∂ÈïøÈáçËØïÈó¥ÈöîÂà∞500ms
        } else {
          console.error('‚ùå [ÂõæË°®È¢ÑËßà] ÈáçËØïÊ¨°Êï∞Â∑≤Ëææ‰∏äÈôê')
          message.error('È¢ÑËßàÂÆπÂô®Êú™ÂáÜÂ§áÂ•ΩÔºåËØ∑ÈáçËØï')
          modalLoading.value = false
          delete (window as any).chartRetryCount
        }
      }
    }

    // ÈáçÁΩÆÈáçËØïËÆ°Êï∞Âô®
    delete (window as any).chartRetryCount

    // Âª∂ËøüÂàùÂßãÂåñÔºåÁªôÊõ¥Â§öÊó∂Èó¥
    setTimeout(initChart, 500)

  } catch (error) {
    console.error('‚ùå [ÂõæË°®È¢ÑËßà] È¢ÑËßàÁîüÊàêÂ§±Ë¥•:', error)
    message.error('ÂõæË°®È¢ÑËßàÁîüÊàêÂ§±Ë¥•')
    modalLoading.value = false
  }
}

// Â§ÑÁêÜÈ¢ÑËßàÂºπÊ°ÜÂÖ≥Èó≠
const handlePreviewClose = () => {
  console.log('üîí [ÂõæË°®È¢ÑËßà] ÂºπÊ°ÜÂÖ≥Èó≠ÔºåÊ∏ÖÁêÜËµÑÊ∫ê')

  // Ê∏ÖÁêÜEChartsÂÆû‰æãÂíå‰∫ã‰ª∂ÁõëÂê¨Âô®
  if (chartPreviewRef.value) {
    const savedChartInstance = (chartPreviewRef.value as any)._chartInstance
    const savedResizeHandler = (chartPreviewRef.value as any)._resizeHandler

    if (savedChartInstance) {
      savedChartInstance.dispose()
      console.log('üóëÔ∏è [ÂõæË°®È¢ÑËßà] EChartsÂÆû‰æãÂ∑≤ÈîÄÊØÅ')
    }

    if (savedResizeHandler) {
      window.removeEventListener('resize', savedResizeHandler)
      console.log('üóëÔ∏è [ÂõæË°®È¢ÑËßà] Á™óÂè£resizeÁõëÂê¨Âô®Â∑≤ÁßªÈô§')
    }

    // Ê∏ÖÁêÜÂºïÁî®
    delete (chartPreviewRef.value as any)._chartInstance
    delete (chartPreviewRef.value as any)._resizeHandler
  }

  // ÈáçÁΩÆÁä∂ÊÄÅ
  chartPreviewData.value = null
  modalLoading.value = false

  console.log('‚úÖ [ÂõæË°®È¢ÑËßà] ËµÑÊ∫êÊ∏ÖÁêÜÂÆåÊàê')
}

// Ëé∑ÂèñÁ§∫‰æãÂõæË°®Êï∞ÊçÆ
const getSampleChartData = () => {
  if (!selectedRecord.value) return {}

  const sampleConfigs: Record<string, any> = {
    // Ê†πÊçÆÂõæË°®IDÂåπÈÖçÂØπÂ∫îÁöÑEChartsÈÖçÁΩÆ
    'smooth_line_chart': {
      xAxis: {
        type: 'category',
        data: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun']
      },
      yAxis: {
        type: 'value'
      },
      series: [{
        data: [100, 300, 150, 400, 200, 350, 250],
        type: 'line',
        smooth: true,
        symbol: 'circle',
        symbolSize: 6,
        lineStyle: {
          width: 2
        }
      }]
    },
    'basic_line_chart': {
      xAxis: {
        type: 'category',
        data: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun']
      },
      yAxis: {
        type: 'value'
      },
      series: [{
        data: [100, 300, 150, 400, 200, 350, 250],
        type: 'line',
        smooth: false,
        symbol: 'circle',
        symbolSize: 6,
        lineStyle: {
          width: 2
        }
      }]
    },
    // ÊåâÂõæË°®Á±ªÂûãÁöÑÂõûÈÄÄÈÖçÁΩÆ
    'ÊäòÁ∫øÂõæ': {
      title: {
        text: 'ÊúàÂ∫¶ÈîÄÂîÆË∂ãÂäø'
      },
      tooltip: {
        trigger: 'axis'
      },
      legend: {
        data: ['‰∫ßÂìÅAÈîÄÈáè', '‰∫ßÂìÅBÈîÄÈáè']
      },
      xAxis: {
        type: 'category',
        data: ['1Êúà', '2Êúà', '3Êúà', '4Êúà', '5Êúà', '6Êúà']
      },
      yAxis: {
        type: 'value'
      },
      series: [
        {
          name: '‰∫ßÂìÅAÈîÄÈáè',
          type: 'line',
          data: [120, 200, 150, 80, 70, 110]
        },
        {
          name: '‰∫ßÂìÅBÈîÄÈáè',
          type: 'line',
          data: [80, 160, 120, 60, 50, 90]
        }
      ]
    },
    'Êü±Áä∂Âõæ': {
      title: {
        text: 'Â≠£Â∫¶‰∏öÁª©ÂØπÊØî'
      },
      tooltip: {
        trigger: 'axis'
      },
      legend: {
        data: ['ÂÆûÈôÖ‰∏öÁª©', 'ÁõÆÊ†á‰∏öÁª©']
      },
      xAxis: {
        type: 'category',
        data: ['Q1', 'Q2', 'Q3', 'Q4']
      },
      yAxis: {
        type: 'value'
      },
      series: [
        {
          name: 'ÂÆûÈôÖ‰∏öÁª©',
          type: 'bar',
          data: [850, 920, 780, 1100]
        },
        {
          name: 'ÁõÆÊ†á‰∏öÁª©',
          type: 'bar',
          data: [800, 900, 750, 1000]
        }
      ]
    },
    'È•ºÂõæ': {
      title: {
        text: 'Â∏ÇÂú∫‰ªΩÈ¢ùÂàÜÂ∏É'
      },
      tooltip: {
        trigger: 'item'
      },
      series: [{
        type: 'pie',
        radius: '50%',
        data: [
          { name: '‰∫ßÂìÅA', value: 35 },
          { name: '‰∫ßÂìÅB', value: 25 },
          { name: '‰∫ßÂìÅC', value: 20 },
          { name: '‰∫ßÂìÅD', value: 15 },
          { name: 'ÂÖ∂‰ªñ', value: 5 }
        ]
      }]
    },
    'Èõ∑ËææÂõæ': {
      title: {
        text: 'ËÉΩÂäõËØÑ‰º∞Èõ∑ËææÂõæ'
      },
      radar: {
        indicator: [
          { name: 'ÊäÄÊúØËÉΩÂäõ', max: 100 },
          { name: 'Ê≤üÈÄöËÉΩÂäõ', max: 100 },
          { name: 'ÁÆ°ÁêÜËÉΩÂäõ', max: 100 },
          { name: 'ÂàõÊñ∞ËÉΩÂäõ', max: 100 },
          { name: 'ÊâßË°åËÉΩÂäõ', max: 100 }
        ]
      },
      series: [{
        type: 'radar',
        data: [
          {
            name: 'ÂëòÂ∑•A',
            value: [85, 75, 60, 90, 80]
          },
          {
            name: 'ÂëòÂ∑•B',
            value: [70, 85, 80, 75, 85]
          }
        ]
      }]
    },
    '‰ª™Ë°®Áõò': {
      title: {
        text: 'È°πÁõÆÂÆåÊàêÂ∫¶'
      },
      series: [{
        type: 'gauge',
        data: [{
          value: 75,
          name: 'ÂÆåÊàêÁéá'
        }]
      }]
    }
  }

  // ‰ºòÂÖàÊ†πÊçÆÂõæË°®IDÂåπÈÖçÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàôÊ†πÊçÆÂõæË°®Á±ªÂûãÂåπÈÖç
  return sampleConfigs[selectedRecord.value.chartId] ||
         sampleConfigs[selectedRecord.value.chartType] ||
         sampleConfigs['smooth_line_chart']
}





// ÁõëÂê¨Ê®°ÊÄÅÊ°ÜÁä∂ÊÄÅÂèòÂåñ
watch(mappingModalVisible, (newVal) => {
  console.log('üëÅÔ∏è [Ê®°ÊÄÅÊ°Ü] ÈÖçÁΩÆÊò†Â∞ÑÊ®°ÊÄÅÊ°ÜÁä∂ÊÄÅÂèòÂåñ:', newVal)
  if (newVal) {
    console.log('üìä [Ê®°ÊÄÅÊ°Ü] ÈÖçÁΩÆÊò†Â∞ÑÊ®°ÊÄÅÊ°ÜÂ∑≤ÊâìÂºÄÔºåÂΩìÂâçËÆ∞ÂΩï:', selectedRecord.value)
  }
})

watch(guideModalVisible, (newVal) => {
  console.log('üëÅÔ∏è [Ê®°ÊÄÅÊ°Ü] ÈÖçÁΩÆÊåáÂçóÊ®°ÊÄÅÊ°ÜÁä∂ÊÄÅÂèòÂåñ:', newVal)
  if (newVal) {
    console.log('üìñ [Ê®°ÊÄÅÊ°Ü] ÈÖçÁΩÆÊåáÂçóÊ®°ÊÄÅÊ°ÜÂ∑≤ÊâìÂºÄÔºåÂΩìÂâçËÆ∞ÂΩï:', selectedRecord.value)
  }
})

// ÁîüÂëΩÂë®Êúü
onMounted(async () => {
  console.log('üöÄ [Êò†Â∞ÑÁÆ°ÁêÜ] È°µÈù¢ÊåÇËΩΩÂÆåÊàê')
  console.log('üìä [Êò†Â∞ÑÁÆ°ÁêÜ] ÂàùÂßãÊ®°ÊÄÅÊ°Ü‰ΩçÁΩÆ:', {
    mapping: mappingModalPosition.value,
    guide: guideModalPosition.value
  })
  await refreshList()
})

console.log('üöÄ [Êò†Â∞ÑÁÆ°ÁêÜ] È°µÈù¢ÁªÑ‰ª∂ÂàùÂßãÂåñ')
</script>

<style scoped>
/* È°µÈù¢Âü∫Á°ÄÊ†∑Âºè - ÂÆåÂÖ®ÈÄèÊòéËÉåÊôØÔºå‰∏çÈÅÆÊå°Â∫ïÂ±ÇÂÜÖÂÆπ */
.mapping-page {
  padding: 12px;
  background: none;
  min-height: auto;
  position: static;
}

/* Âå∫ÂüüÂç°ÁâáÊ†∑Âºè - ÊûÅÈ´òÈÄèÊòéÂ∫¶ÔºåÊúÄÂ∞èÂåñËßÜËßâÂπ≤Êâ∞ */
.selection-card,
.list-card {
  background: rgba(255, 255, 255, 0.2) !important;
  border: 1px solid rgba(255, 255, 255, 0.15);
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.01);
  margin-bottom: 12px;
  backdrop-filter: blur(2px);
}

.selection-card :deep(.ant-card-body),
.list-card :deep(.ant-card-body) {
  background: transparent;
  padding: 12px;
}

.selection-card :deep(.ant-card-head),
.list-card :deep(.ant-card-head) {
  background: rgba(255, 255, 255, 0.1);
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

/* Ê†áÈ¢òÊ†∑Âºè */
.section-title {
  font-weight: 600;
  color: #1890ff;
  font-size: 14px;
}

/* ÂõæË°®ÈÄâÊã©Âô®Ê†∑Âºè */
.chart-selector {
  background: transparent;
}

/* ÊãñÊãΩÊ†áÈ¢òÊ†∑Âºè */
.draggable-title {
  cursor: move;
  user-select: none;
  padding: 4px 0;
  font-weight: 600;
  color: #262626;
  transition: all 0.2s;
  border-radius: 4px;
  padding: 8px 12px;
  margin: -8px -12px;
}

.draggable-title:hover {
  color: #1890ff;
  background-color: rgba(24, 144, 255, 0.1);
}

.draggable-title:active {
  cursor: grabbing;
  background-color: rgba(24, 144, 255, 0.2);
  transform: scale(0.98);
}

/* ÊãñÊãΩÊó∂ÁöÑÂÖ®Â±ÄÊ†∑Âºè */
body.dragging {
  cursor: grabbing !important;
  user-select: none !important;
}

body.dragging * {
  cursor: grabbing !important;
}

/* ÈÖçÁΩÆÊò†Â∞ÑÁã¨Á´ãÊµÆÂä®Á™óÂè£Ê†∑Âºè */
.mapping-floating-window {
  position: fixed;
  width: 1000px; /* ‰øùÊåÅÂéüÊúâÂÆΩÂ∫¶ */
  max-height: 80vh;
  background: #ffffff;
  border-radius: 8px;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
  border: 1px solid #e8e8e8;
  overflow: hidden;
  z-index: 1001;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

/* ÈÖçÁΩÆÊåáÂçóÁã¨Á´ãÊµÆÂä®Á™óÂè£Ê†∑Âºè */
.guide-floating-window {
  position: fixed;
  width: 900px; /* ‰ºòÂåñÂêéÁöÑÂÆΩÂ∫¶ */
  max-height: 80vh;
  background: #ffffff;
  border-radius: 8px;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
  border: 1px solid #e8e8e8;
  overflow: hidden;
  z-index: 1002;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

/* Á™óÂè£Ê†áÈ¢òÊ†è */
.window-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 16px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  cursor: move;
  user-select: none;
  border-bottom: 1px solid #e8e8e8;
}

.window-header:hover {
  background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
}

.window-title {
  display: flex;
  align-items: center;
  font-weight: 600;
  font-size: 14px;
}

.title-icon {
  margin-right: 8px;
  font-size: 16px;
}

.title-text {
  color: white;
}

.window-controls {
  display: flex;
  gap: 8px;
}

.control-btn {
  width: 24px;
  height: 24px;
  border: none;
  border-radius: 4px;
  background: rgba(255, 255, 255, 0.2);
  color: white;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  transition: all 0.2s;
}

.control-btn:hover {
  background: rgba(255, 255, 255, 0.3);
  transform: scale(1.1);
}

.close-btn:hover {
  background: #ff4757;
}

/* Á™óÂè£ÂÜÖÂÆπÂå∫Âüü */
.window-content {
  max-height: calc(80vh - 60px);
  overflow-y: auto;
  padding: 16px;
}

.guide-content {
  height: 100%;
}

.guide-panels {
  display: flex;
  gap: 16px;
  height: 100%;
}

.guide-panel {
  flex: 1;
  display: flex;
  flex-direction: column;
  border: 1px solid #e8e8e8;
  border-radius: 6px;
  overflow: hidden;
}

.panel-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 16px;
  background: #fafafa;
  border-bottom: 1px solid #e8e8e8;
}

.panel-title {
  display: flex;
  align-items: center;
  margin: 0;
  font-size: 14px;
  font-weight: 600;
  color: #262626;
}

.panel-icon {
  margin-right: 8px;
  font-size: 16px;
}

.panel-content {
  flex: 1;
  padding: 16px;
  overflow-y: auto;
}

.section {
  margin-bottom: 20px;
}

.section:last-child {
  margin-bottom: 0;
}

.section h5 {
  margin: 0 0 8px 0;
  font-size: 13px;
  font-weight: 600;
  color: #1890ff;
}

.section h6 {
  margin: 12px 0 6px 0;
  font-size: 12px;
  font-weight: 600;
  color: #595959;
}

.code-container {
  margin: 8px 0;
}

.code-block {
  background: #f5f5f5;
  border: 1px solid #e8e8e8;
  border-radius: 4px;
  padding: 12px;
  font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
  font-size: 11px;
  line-height: 1.4;
  color: #333;
  white-space: pre-wrap;
  word-break: break-all;
  max-height: 200px;
  overflow-y: auto;
}

.description-list {
  margin: 8px 0;
  padding-left: 16px;
}

.description-list li {
  margin: 4px 0;
  font-size: 12px;
  color: #666;
  line-height: 1.4;
}

.placeholder-tags {
  margin: 8px 0;
  padding: 8px;
  background: #fafafa;
  border-radius: 4px;
  max-height: 120px;
  overflow-y: auto;
}

/* Á™óÂè£Â∫ïÈÉ®Êìç‰ΩúÊ†èÊ†∑Âºè */
.window-footer {
  border-top: 1px solid #e8e8e8;
  padding: 12px 16px;
  background: #fafafa;
  display: flex;
  justify-content: flex-end;
}

.footer-actions {
  display: flex;
  gap: 12px;
}

.action-btn {
  padding: 8px 16px;
  border: none;
  border-radius: 6px;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 6px;
  min-width: 100px;
  justify-content: center;
}

.cancel-btn {
  background: #f5f5f5;
  color: #666;
  border: 1px solid #d9d9d9;
}

.cancel-btn:hover {
  background: #e6f7ff;
  border-color: #91d5ff;
  color: #1890ff;
}

.primary-btn {
  background: linear-gradient(135deg, #1890ff 0%, #096dd9 100%);
  color: white;
  border: 1px solid #1890ff;
}

.primary-btn:hover:not(:disabled) {
  background: linear-gradient(135deg, #40a9ff 0%, #1890ff 100%);
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(24, 144, 255, 0.3);
}

.primary-btn:disabled {
  background: #f5f5f5;
  color: #bfbfbf;
  border-color: #d9d9d9;
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}

.loading-icon {
  animation: spin 1s linear infinite;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

/* Ê®°ÊÄÅÊ°ÜÊ†∑Âºè - Á°Æ‰øùÊ≠£Á°ÆÂÆö‰ΩçÂíåÊó†ÈÅÆÁΩ© */
.mapping-modal :deep(.ant-modal),
.guide-modal :deep(.ant-modal) {
  position: fixed !important;
  margin: 0 !important;
  transform: none !important;
  top: auto !important;
  left: auto !important;
  max-width: none !important;
  width: auto !important;
}

/* Á°Æ‰øùÊ®°ÊÄÅÊ°ÜÂèØ‰ª•Ë∂ÖÂá∫ËßÜÂè£ËæπÁïå */
.mapping-modal :deep(.ant-modal),
.guide-modal :deep(.ant-modal) {
  overflow: visible !important;
}

/* Ê®°ÊÄÅÊ°ÜÂÜÖÂÆπÂå∫ÂüüÊ†∑Âºè */
.mapping-modal :deep(.ant-modal-content),
.guide-modal :deep(.ant-modal-content) {
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  border-radius: 8px;
  overflow: visible;
}

/* Ê®°ÊÄÅÊ°ÜÂåÖË£ÖÂô®Ê†∑Âºè */
.mapping-modal-wrap,
.guide-modal-wrap {
  position: static !important;
  pointer-events: none;
  z-index: auto !important;
}

.mapping-modal-wrap :deep(.ant-modal),
.guide-modal-wrap :deep(.ant-modal) {
  pointer-events: auto;
}

/* ÈÖçÁΩÆÊò†Â∞ÑÊ®°ÊÄÅÊ°Üz-index */
.mapping-modal-wrap {
  z-index: 1001 !important;
}

.mapping-modal-wrap :deep(.ant-modal) {
  z-index: 1001 !important;
}

/* ÂÆåÂÖ®ÈöêËóèÈÅÆÁΩ©Â±Ç */
.mapping-modal :deep(.ant-modal-mask),
.guide-modal :deep(.ant-modal-mask),
.mapping-modal-wrap :deep(.ant-modal-mask),
.guide-modal-wrap :deep(.ant-modal-mask) {
  display: none !important;
}

.mapping-modal :deep(.ant-modal-wrap),
.guide-modal :deep(.ant-modal-wrap) {
  position: static !important;
  overflow: visible !important;
  pointer-events: none;
}

.mapping-modal :deep(.ant-modal-wrap .ant-modal),
.guide-modal :deep(.ant-modal-wrap .ant-modal) {
  pointer-events: auto;
}

/* Ê®°ÊÄÅÊ°ÜÂÜÖÂÆπÊ†∑Âºè */
.modal-content {
  max-height: 70vh;
  overflow-y: auto;
}

/* Êò†Â∞ÑÈÖçÁΩÆÊ†∑Âºè */
.mapping-config-section {
  margin-top: 16px;
}

.mapping-config-section h4 {
  margin: 16px 0 12px 0;
  color: #1890ff;
  font-weight: 600;
}

.mapping-header {
  background: #fafafa;
  padding: 8px 12px;
  border-radius: 4px;
  margin-bottom: 8px;
  border: 1px solid #e8e8e8;
}

.mapping-list {
  max-height: 300px;
  overflow-y: auto;
  border: 1px solid #e8e8e8;
  border-radius: 4px;
}

.mapping-item {
  padding: 8px 12px;
  border-bottom: 1px solid #f0f0f0;
  transition: background-color 0.2s;
}

.mapping-item:hover {
  background-color: #f9f9f9;
}

.mapping-item:last-child {
  border-bottom: none;
}

.placeholder-info {
  display: flex;
  align-items: center;
}

.mapping-progress {
  margin-top: 16px;
  padding: 12px;
  background: #f6f8fa;
  border-radius: 4px;
}

.loading-container {
  display: flex;
  justify-content: center;
  align-items: center;
  height: 200px;
}

/* ÈÖçÁΩÆÊåáÂçóÊ†∑Âºè */
.guide-card {
  height: 100%;
  border-radius: 8px;
}

.guide-section {
  padding: 8px 0;
}

.guide-section h4 {
  margin: 0 0 12px 0;
  color: #1890ff;
  font-size: 14px;
  font-weight: 600;
}

.guide-section h5 {
  margin: 16px 0 8px 0;
  color: #262626;
  font-size: 13px;
  font-weight: 600;
}

.code-block {
  background: #f5f5f5;
  border: 1px solid #e8e8e8;
  border-radius: 4px;
  padding: 12px;
  margin: 8px 0;
  overflow-x: auto;
}

.code-block pre {
  margin: 0;
  font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
  font-size: 12px;
  line-height: 1.4;
  color: #333;
}

/* JOLTËßÑËåÉÊñá‰ª∂ÂÜÖÂÆπÊ†∑Âºè */
.jolt-spec-section {
  margin-top: 16px;
}

.jolt-spec-section h4 {
  margin-bottom: 12px;
  color: #1890ff;
  font-weight: 600;
}

.jolt-spec-content .code-container {
  max-height: 300px;
  overflow-y: auto;
  border: 1px solid #d9d9d9;
  border-radius: 6px;
}

.jolt-spec-content .code-block {
  margin: 0;
  border: none;
  border-radius: 0;
  background: #fafafa;
}

.json-highlight {
  background: #fafafa;
  color: #333;
}

.no-jolt-spec {
  padding: 20px;
  text-align: center;
  background: #fafafa;
  border: 1px dashed #d9d9d9;
  border-radius: 6px;
}

/* ÂõæË°®È¢ÑËßàÂºπÊ°ÜÊ†∑Âºè */
.chart-preview-content {
  padding: 16px 0;
}

.preview-loading {
  display: flex;
  justify-content: center;
  align-items: center;
  height: 300px;
}

.preview-container {
  width: 100%;
}

.chart-preview-canvas {
  border: 1px solid #e8e8e8;
  border-radius: 6px;
  background: white;
}

.no-preview {
  display: flex;
  justify-content: center;
  align-items: center;
  height: 300px;
  background: #fafafa;
  border: 1px dashed #d9d9d9;
  border-radius: 6px;
}



.structure-description ul {
  margin: 8px 0;
  padding-left: 20px;
}

.structure-description li {
  margin: 4px 0;
  font-size: 12px;
  color: #666;
}

.transformation-info {
  padding: 8px 0;
}

.placeholder-list {
  margin: 8px 0;
  padding: 8px;
  background: #fafafa;
  border-radius: 4px;
}

/* ÈÄöÁî®Ê®°ÊùøÊ†∑Âºè */
.loading-container {
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 40px;
  background: #fafafa;
  border-radius: 6px;
  border: 1px dashed #d9d9d9;
}

.error-container {
  padding: 16px;
  background: #fff2f0;
  border-radius: 6px;
  border: 1px solid #ffccc7;
}

.empty-container {
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 40px;
  background: #fafafa;
  border-radius: 6px;
  border: 1px dashed #d9d9d9;
}

.code-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 12px;
  background: #f0f0f0;
  border-radius: 6px 6px 0 0;
  border-bottom: 1px solid #d9d9d9;
}

.code-title {
  font-weight: 500;
  color: #262626;
  font-size: 13px;
}

.universal-template-code {
  background: #f8f8f8 !important;
  border: 1px solid #e8e8e8;
  border-radius: 0 0 6px 6px;
  max-height: 400px;
  overflow-y: auto;
  font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', monospace;
  font-size: 11px;
  line-height: 1.5;
  color: #2c3e50;
}

.code-example,
.transformation-info .code-block {
  background: #f5f5f5;
  padding: 12px;
  border-radius: 4px;
  font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
  font-size: 12px;
  line-height: 1.4;
  color: #333;
  white-space: pre-wrap;
  word-break: break-all;
}

/* Ë°®Ê†ºÊ†∑Âºè‰ºòÂåñ */
:deep(.ant-table-thead > tr > th) {
  background: rgba(250, 250, 250, 0.8);
  font-weight: 600;
}

:deep(.ant-table-tbody > tr:hover > td) {
  background: rgba(246, 255, 237, 0.8);
}

/* ÊåâÈíÆÊ†∑Âºè‰ºòÂåñ */
:deep(.ant-btn-link) {
  padding: 2px 4px;
  height: auto;
  font-size: 12px;
}

/* ÂìçÂ∫îÂºèËÆæËÆ° */
@media (max-width: 1200px) {
  .mapping-page {
    padding: 8px;
  }

  .selection-card,
  .list-card {
    margin-bottom: 8px;
  }

  .modal-content {
    max-height: 50vh;
  }

  /* ÊµÆÂä®Á™óÂè£ÂìçÂ∫îÂºè */
  .mapping-floating-window {
    width: 95vw;
    max-width: 900px;
  }

  .guide-floating-window {
    width: 95vw;
    max-width: 800px;
  }

  .guide-panels {
    flex-direction: column;
    gap: 12px;
  }

  .code-block {
    font-size: 10px;
    max-height: 150px;
  }
}

@media (max-width: 768px) {
  .mapping-floating-window,
  .guide-floating-window {
    width: 98vw;
    max-height: 90vh;
  }

  .window-header {
    padding: 8px 12px;
  }

  .title-text {
    font-size: 12px;
  }

  .panel-content {
    padding: 12px;
  }

  /* Á¥ßÂáëÂûãË°®Ê†ºÊ†∑Âºè */
  .compact-table {
    :deep(.ant-table-thead > tr > th) {
      padding: 8px 12px !important;
      font-size: 12px;
      font-weight: 600;
      background: #fafafa;
      border-bottom: 1px solid #e8e8e8;
    }

    :deep(.ant-table-tbody > tr > td) {
      padding: 6px 12px !important;
      font-size: 12px;
      line-height: 1.4;
      border-bottom: 1px solid #f0f0f0;
    }

    :deep(.ant-table-tbody > tr:hover > td) {
      background: #f5f5f5;
    }

    :deep(.ant-btn-link) {
      padding: 0 4px;
      font-size: 12px;
      height: auto;
      line-height: 1.4;
    }

    :deep(.ant-space-item) {
      margin-right: 4px !important;
    }
  }

  .code-block {
    font-size: 9px;
    padding: 8px;
  }
}

/* ÂõæË°®È¢ÑËßàÊ†∑Âºè */
.chart-preview-container {
  .preview-error {
    margin-bottom: 16px;
  }

  .chart-container {
    border: 1px solid #d9d9d9;
    border-radius: 6px;
    overflow: hidden;
  }

  .preview-loading {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 400px;
  }
}
</style>